var e={415:e=>{var t,s="object"==typeof Reflect?Reflect:null,i=s&&"function"==typeof s.apply?s.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)};t=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function r(){r.init.call(this)}e.exports=r,e.exports.once=function(e,t){return new Promise((function(s,i){function n(s){e.removeListener(t,r),i(s)}function r(){"function"==typeof e.removeListener&&e.removeListener("error",n),s([].slice.call(arguments))}p(e,t,r,{once:!0}),"error"!==t&&function(e,t,s){"function"==typeof e.on&&p(e,"error",t,s)}(e,n,{once:!0})}))},r.EventEmitter=r,r.prototype._events=void 0,r.prototype._eventsCount=0,r.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?r.defaultMaxListeners:e._maxListeners}function c(e,t,s,i){var n,r,o,c;if(a(s),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),r=e._events),o=r[t]),void 0===o)o=r[t]=s,++e._eventsCount;else if("function"==typeof o?o=r[t]=i?[s,o]:[o,s]:i?o.unshift(s):o.push(s),(n=h(e))>0&&o.length>n&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,c=l,console&&console.warn&&console.warn(c)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,s){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:s},n=l.bind(i);return n.listener=s,i.wrapFn=n,n}function u(e,t,s){var i=e._events;if(void 0===i)return[];var n=i[t];return void 0===n?[]:"function"==typeof n?s?[n.listener||n]:[n]:s?function(e){for(var t=new Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}(n):f(n,n.length)}function g(e){var t=this._events;if(void 0!==t){var s=t[e];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function f(e,t){for(var s=new Array(t),i=0;i<t;++i)s[i]=e[i];return s}function p(e,t,s,i){if("function"==typeof e.on)i.once?e.once(t,s):e.on(t,s);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function n(r){i.once&&e.removeEventListener(t,n),s(r)}))}}Object.defineProperty(r,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),r.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},r.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},r.prototype.getMaxListeners=function(){return h(this)},r.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var n="error"===e,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var h=r[e];if(void 0===h)return!1;if("function"==typeof h)i(h,this,t);else{var c=h.length,l=f(h,c);for(s=0;s<c;++s)i(l[s],this,t)}return!0},r.prototype.addListener=function(e,t){return c(this,e,t,!1)},r.prototype.on=r.prototype.addListener,r.prototype.prependListener=function(e,t){return c(this,e,t,!0)},r.prototype.once=function(e,t){return a(t),this.on(e,d(this,e,t)),this},r.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,d(this,e,t)),this},r.prototype.removeListener=function(e,t){var s,i,n,r,o;if(a(t),void 0===(i=this._events))return this;if(void 0===(s=i[e]))return this;if(s===t||s.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(n=-1,r=s.length-1;r>=0;r--)if(s[r]===t||s[r].listener===t){o=s[r].listener,n=r;break}if(n<0)return this;0===n?s.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(s,n),1===s.length&&(i[e]=s[0]),void 0!==i.removeListener&&this.emit("removeListener",e,o||t)}return this},r.prototype.off=r.prototype.removeListener,r.prototype.removeAllListeners=function(e){var t,s,i;if(void 0===(s=this._events))return this;if(void 0===s.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete s[e]),this;if(0===arguments.length){var n,r=Object.keys(s);for(i=0;i<r.length;++i)"removeListener"!==(n=r[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},r.prototype.listeners=function(e){return u(this,e,!0)},r.prototype.rawListeners=function(e){return u(this,e,!1)},r.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},r.prototype.listenerCount=g,r.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},558:function(e){!function(t){var s=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,i=/^(?=([^\/?#]*))\1([^]*)$/,n=/(?:\/|^)\.(?=\/)/g,r=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(e,t,s){if(s=s||{},e=e.trim(),!(t=t.trim())){if(!s.alwaysNormalize)return e;var n=o.parseURL(e);if(!n)throw new Error("Error trying to parse base URL.");return n.path=o.normalizePath(n.path),o.buildURLFromParts(n)}var r=o.parseURL(t);if(!r)throw new Error("Error trying to parse relative URL.");if(r.scheme)return s.alwaysNormalize?(r.path=o.normalizePath(r.path),o.buildURLFromParts(r)):t;var a=o.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var h=i.exec(a.path);a.netLoc=h[1],a.path=h[2]}a.netLoc&&!a.path&&(a.path="/");var c={scheme:a.scheme,netLoc:r.netLoc,path:null,params:r.params,query:r.query,fragment:r.fragment};if(!r.netLoc&&(c.netLoc=a.netLoc,"/"!==r.path[0]))if(r.path){var l=a.path,d=l.substring(0,l.lastIndexOf("/")+1)+r.path;c.path=o.normalizePath(d)}else c.path=a.path,r.params||(c.params=a.params,r.query||(c.query=a.query));return null===c.path&&(c.path=s.alwaysNormalize?o.normalizePath(r.path):r.path),o.buildURLFromParts(c)},parseURL:function(e){var t=s.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(n,"");e.length!==(e=e.replace(r,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};e.exports=o}()},424:(e,t)=>{t.h=n;var s=2147483647;function i(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=n.prototype,t}function n(e,t,s){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return a(e)}return r(e,t,s)}function r(e,t,s){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!n.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var s=0|l(e,t),r=i(s),o=r.write(e,t);o!==s&&(r=r.slice(0,o));return r}(e,t);if(ArrayBuffer.isView(e))return h(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(_(e,ArrayBuffer)||e&&_(e.buffer,ArrayBuffer))return function(e,t,s){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(s||0))throw new RangeError('"length" is outside of buffer bounds');var i;i=void 0===t&&void 0===s?new Uint8Array(e):void 0===s?new Uint8Array(e,t):new Uint8Array(e,t,s);return i.__proto__=n.prototype,i}(e,t,s);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return n.from(r,t,s);var o=function(e){if(n.isBuffer(e)){var t=0|c(e.length),s=i(t);return 0===s.length||e.copy(s,0,0,t),s}if(void 0!==e.length)return"number"!=typeof e.length||S(e.length)?i(0):h(e);if("Buffer"===e.type&&Array.isArray(e.data))return h(e.data)}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return n.from(e[Symbol.toPrimitive]("string"),t,s);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function o(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function a(e){return o(e),i(e<0?0:0|c(e))}function h(e){for(var t=e.length<0?0:0|c(e.length),s=i(t),n=0;n<t;n+=1)s[n]=255&e[n];return s}function c(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function l(e,t){if(n.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||_(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var s=e.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===s)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return s;case"utf8":case"utf-8":return m(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*s;case"hex":return s>>>1;default:if(r)return i?-1:m(e).length;t=(""+t).toLowerCase(),r=!0}}function d(e,t,s,i){s=Number(s)||0;const n=e.length-s;i?(i=Number(i))>n&&(i=n):i=n;const r=t.length;let o;for(i>r/2&&(i=r/2),o=0;o<i;++o){const i=parseInt(t.substr(2*o,2),16);if(S(i))return o;e[s+o]=i}return o}function u(e,t,s,i){return p(m(t,e.length-s),e,s,i)}function g(e,t,s,i){return p(function(e){const t=[];for(let s=0;s<e.length;++s)t.push(255&e.charCodeAt(s));return t}(t),e,s,i)}function f(e,t,s,i){return p(function(e,t){let s,i,n;const r=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)s=e.charCodeAt(o),i=s>>8,n=s%256,r.push(n),r.push(i);return r}(t,e.length-s),e,s,i)}function p(e,t,s,i){let n;for(n=0;n<i&&!(n+s>=t.length||n>=e.length);++n)t[n+s]=e[n];return n}function m(e,t){var s;t=t||1/0;for(var i=e.length,n=null,r=[],o=0;o<i;++o){if((s=e.charCodeAt(o))>55295&&s<57344){if(!n){if(s>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(o+1===i){(t-=3)>-1&&r.push(239,191,189);continue}n=s;continue}if(s<56320){(t-=3)>-1&&r.push(239,191,189),n=s;continue}s=65536+(n-55296<<10|s-56320)}else n&&(t-=3)>-1&&r.push(239,191,189);if(n=null,s<128){if((t-=1)<0)break;r.push(s)}else if(s<2048){if((t-=2)<0)break;r.push(s>>6|192,63&s|128)}else if(s<65536){if((t-=3)<0)break;r.push(s>>12|224,s>>6&63|128,63&s|128)}else{if(!(s<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}}return r}function _(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function S(e){return e!=e}"undefined"!=typeof Symbol&&null!=Symbol.species&&n[Symbol.species]===n&&Object.defineProperty(n,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),n.from=function(e,t,s){return r(e,t,s)},n.prototype.__proto__=Uint8Array.prototype,n.__proto__=Uint8Array,n.alloc=function(e,t,s){return function(e,t,s){return o(e),e<=0?i(e):void 0!==t?"string"==typeof s?i(e).fill(t,s):i(e).fill(t):i(e)}(e,t,s)},n.allocUnsafe=function(e){return a(e)},n.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==n.prototype},n.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},n.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return n.alloc(0);var s;if(void 0===t)for(t=0,s=0;s<e.length;++s)t+=e[s].length;var i=n.allocUnsafe(t),r=0;for(s=0;s<e.length;++s){var o=e[s];if(_(o,Uint8Array)&&(o=n.from(o)),!n.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(i,r),r+=o.length}return i},n.byteLength=l,n.prototype._isBuffer=!0,n.prototype.copy=function(e,t,s,i){if(!n.isBuffer(e))throw new TypeError("argument should be a Buffer");if(s||(s=0),i||0===i||(i=this.length),t>=e.length&&(t=e.length),t||(t=0),i>0&&i<s&&(i=s),i===s)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(s<0||s>=this.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-s&&(i=e.length-t+s);var r=i-s;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,s,i);else if(this===e&&s<t&&t<i)for(var o=r-1;o>=0;--o)e[o+t]=this[o+s];else Uint8Array.prototype.set.call(e,this.subarray(s,i),t);return r},n.prototype.write=function(e,t,s,i){if(void 0===t)i="utf8",s=this.length,t=0;else if(void 0===s&&"string"==typeof t)i=t,s=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(s)?(s>>>=0,void 0===i&&(i="utf8")):(i=s,s=void 0)}const n=this.length-t;if((void 0===s||s>n)&&(s=n),e.length>0&&(s<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");let r=!1;for(;;)switch(i){case"hex":return d(this,e,t,s);case"utf8":case"utf-8":return u(this,e,t,s);case"ascii":case"latin1":case"binary":return g(this,e,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return f(this,e,t,s);default:if(r)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),r=!0}}},832:function(e,t,s){var i;!function(n){function r(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function o(e,t,s,i,n,o){return r((a=r(r(t,e),r(i,o)))<<(h=n)|a>>>32-h,s);var a,h}function a(e,t,s,i,n,r,a){return o(t&s|~t&i,e,t,n,r,a)}function h(e,t,s,i,n,r,a){return o(t&i|s&~i,e,t,n,r,a)}function c(e,t,s,i,n,r,a){return o(t^s^i,e,t,n,r,a)}function l(e,t,s,i,n,r,a){return o(s^(t|~i),e,t,n,r,a)}function d(e,t){var s,i,n,o,d;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var u=1732584193,g=-271733879,f=-1732584194,p=271733878;for(s=0;s<e.length;s+=16)i=u,n=g,o=f,d=p,u=a(u,g,f,p,e[s],7,-680876936),p=a(p,u,g,f,e[s+1],12,-389564586),f=a(f,p,u,g,e[s+2],17,606105819),g=a(g,f,p,u,e[s+3],22,-1044525330),u=a(u,g,f,p,e[s+4],7,-176418897),p=a(p,u,g,f,e[s+5],12,1200080426),f=a(f,p,u,g,e[s+6],17,-1473231341),g=a(g,f,p,u,e[s+7],22,-45705983),u=a(u,g,f,p,e[s+8],7,1770035416),p=a(p,u,g,f,e[s+9],12,-1958414417),f=a(f,p,u,g,e[s+10],17,-42063),g=a(g,f,p,u,e[s+11],22,-1990404162),u=a(u,g,f,p,e[s+12],7,1804603682),p=a(p,u,g,f,e[s+13],12,-40341101),f=a(f,p,u,g,e[s+14],17,-1502002290),u=h(u,g=a(g,f,p,u,e[s+15],22,1236535329),f,p,e[s+1],5,-165796510),p=h(p,u,g,f,e[s+6],9,-1069501632),f=h(f,p,u,g,e[s+11],14,643717713),g=h(g,f,p,u,e[s],20,-373897302),u=h(u,g,f,p,e[s+5],5,-701558691),p=h(p,u,g,f,e[s+10],9,38016083),f=h(f,p,u,g,e[s+15],14,-660478335),g=h(g,f,p,u,e[s+4],20,-405537848),u=h(u,g,f,p,e[s+9],5,568446438),p=h(p,u,g,f,e[s+14],9,-1019803690),f=h(f,p,u,g,e[s+3],14,-187363961),g=h(g,f,p,u,e[s+8],20,1163531501),u=h(u,g,f,p,e[s+13],5,-1444681467),p=h(p,u,g,f,e[s+2],9,-51403784),f=h(f,p,u,g,e[s+7],14,1735328473),u=c(u,g=h(g,f,p,u,e[s+12],20,-1926607734),f,p,e[s+5],4,-378558),p=c(p,u,g,f,e[s+8],11,-2022574463),f=c(f,p,u,g,e[s+11],16,1839030562),g=c(g,f,p,u,e[s+14],23,-35309556),u=c(u,g,f,p,e[s+1],4,-1530992060),p=c(p,u,g,f,e[s+4],11,1272893353),f=c(f,p,u,g,e[s+7],16,-155497632),g=c(g,f,p,u,e[s+10],23,-1094730640),u=c(u,g,f,p,e[s+13],4,681279174),p=c(p,u,g,f,e[s],11,-358537222),f=c(f,p,u,g,e[s+3],16,-722521979),g=c(g,f,p,u,e[s+6],23,76029189),u=c(u,g,f,p,e[s+9],4,-640364487),p=c(p,u,g,f,e[s+12],11,-421815835),f=c(f,p,u,g,e[s+15],16,530742520),u=l(u,g=c(g,f,p,u,e[s+2],23,-995338651),f,p,e[s],6,-198630844),p=l(p,u,g,f,e[s+7],10,1126891415),f=l(f,p,u,g,e[s+14],15,-1416354905),g=l(g,f,p,u,e[s+5],21,-57434055),u=l(u,g,f,p,e[s+12],6,1700485571),p=l(p,u,g,f,e[s+3],10,-1894986606),f=l(f,p,u,g,e[s+10],15,-1051523),g=l(g,f,p,u,e[s+1],21,-2054922799),u=l(u,g,f,p,e[s+8],6,1873313359),p=l(p,u,g,f,e[s+15],10,-30611744),f=l(f,p,u,g,e[s+6],15,-1560198380),g=l(g,f,p,u,e[s+13],21,1309151649),u=l(u,g,f,p,e[s+4],6,-145523070),p=l(p,u,g,f,e[s+11],10,-1120210379),f=l(f,p,u,g,e[s+2],15,718787259),g=l(g,f,p,u,e[s+9],21,-343485551),u=r(u,i),g=r(g,n),f=r(f,o),p=r(p,d);return[u,g,f,p]}function u(e){var t,s="",i=32*e.length;for(t=0;t<i;t+=8)s+=String.fromCharCode(e[t>>5]>>>t%32&255);return s}function g(e){var t,s=[];for(s[(e.length>>2)-1]=void 0,t=0;t<s.length;t+=1)s[t]=0;var i=8*e.length;for(t=0;t<i;t+=8)s[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return s}function f(e){var t,s,i="0123456789abcdef",n="";for(s=0;s<e.length;s+=1)t=e.charCodeAt(s),n+=i.charAt(t>>>4&15)+i.charAt(15&t);return n}function p(e){return unescape(encodeURIComponent(e))}function m(e){return function(e){return u(d(g(e),8*e.length))}(p(e))}function _(e,t){return function(e,t){var s,i,n=g(e),r=[],o=[];for(r[15]=o[15]=void 0,n.length>16&&(n=d(n,8*e.length)),s=0;s<16;s+=1)r[s]=909522486^n[s],o[s]=1549556828^n[s];return i=d(r.concat(g(t)),512+8*t.length),u(d(o.concat(i),640))}(p(e),p(t))}function S(e,t,s){return t?s?_(t,e):f(_(t,e)):s?m(e):f(m(e))}void 0===(i=function(){return S}.call(t,s,t,e))||(e.exports=i)}()},365:e=>{const t={ANDROID_WEB:"android-web",IOS_WEB:"iOS-web",PC_NATIVE:"PC-web",PC_WEB:"PC-web"};var s={getNetType:function(){let e=(new RegExp("nettype\\/(\\w*)").exec(i())||[,""])[1].toLowerCase();if(!e&&navigator.connection){switch(navigator.connection.type){case"ethernet":e="ethernet";break;case"cellular":e="cellular";break;default:e="wifi"}}return e},getPlatform:function(){return s.isAndroid()||s.isAndroidWebView()?t.ANDROID_WEB:s.isIOS()||s.isIpad()||s.isIOSWebView()?t.IOS_WEB:s.isElectron()?t.PC_NATIVE:t.PC_WEB},isX5:function(){return this.isAndroid()&&/\s(TBS|X5Core)\/[\w\.\-]+/i.test(i())},isPC:function(){return!r(n("os "))&&!r(n("android[/ ]"))},isIOS:function(){return r(n("os "))},isIpad:function(){return i().match(/(ipad)/)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1},isAndroid:function(){return r(n("android[/ ]"))},isIOSSafari:function(){return this.isIOS()&&this.isSafari()},isIpadSafari:function(){return this.isIpad()&&this.isSafari()},isElectron:function(){return/electron/i.test(i())},isMobile:function(){return s.isAndroid()||s.isIOS()},isSafari:function(){return/^((?!chrome|android).)*safari/i.test(i())},isFirefox:function(){return/firefox/i.test(i())},isChrome:function(){return/chrome/i.test(i())},isLocalHost:function(){return"localhost"===location.hostname},isAndroidWebView:function(){const e=i();return e.indexOf("wv")>-1&&e.indexOf("android")>-1},isIOSWebView:function(){const e=i();return/\b(ipad|iphone|macintosh).*applewebKit(?!.*safari)/i.test(e)},isWebView:function(){return s.isAndroidWebView()||s.isIOSWebView()},device:t,getBrowser:function(){return s.isX5()?"X5":s.isAndroidWebView()?"Android-WebView":s.isIOSWebView()?"iOS-WebView":s.isChrome()?"Chrome":s.isFirefox()?"Firefox":s.isIpadSafari()?"iPad-Safari":s.isIOSSafari()?"iPhone-Safari":s.isSafari()?"Mac-Safari":"Unknown"}};function i(){return navigator.userAgent.toLowerCase()}function n(e){return""+(new RegExp(e+"(\\d+((\\.|_)\\d+)*)").exec(i())||[,0])[1]||void 0}function r(e){return parseFloat((e||"").replace(/\_/g,"."))||0}e.exports=s}},t={};function s(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={exports:{}};return e[i].call(r.exports,r,r.exports,s),r.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var i={};(()=>{s.d(i,{A:()=>Lt});var e=s(558),t=s.n(e);let n={wsMaxRetries:10,p2pEnabled:!0,signalCompact:!0,wifiOnly:!1,memoryCacheLimit:{pc:419430400,mobile:104857600},dcDownloadTimeout:25,logLevel:"error",webRTCConfig:{},token:void 0,appName:void 0,appId:void 0,prefetchNum:3,showSlogan:!0,trickleICE:!0,announceLocation:"eu",trackerZone:void 0,geoIpPreflight:!0,ICEPreflight:!0,useDiskCache:!0,startFromSegmentOffset:3,getStats:function(e,t,s){},getPeerId:function(e){},getPeersInfo:function(e){}};const r={...n,pieceLength:524288,minBufferLength:5,minBufferCount:0,swFile:"./sw.js",swScope:"./",audioTypes:["mp3","wav"],trickleICE:!0,diskCacheLimit:{pc:1572864e3,mobile:1048576e3}};var o=s(415),a=s.n(o);class h{constructor(e,t){this.target=t,this.type=e}}class c extends h{constructor(e,t){super("error",t),this.message=e.message,this.error=e}}class l extends h{constructor(e=1e3,t="",s){super("close",s),this.code=e,this.reason=t,this.wasClean=!0}}const d=()=>{if("undefined"!=typeof WebSocket)return WebSocket},u={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1};class g{constructor(e,t,s={}){this._listeners={error:[],message:[],open:[],close:[]},this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._messageQueue=[],this._closeCalled=!1,this._connectLock=!1,this._shouldReconnect=!0,this._retryCount=-1,this._binaryType="blob",this._url=e,this._protocols=t,this._options=s,this._options.startClosed&&(this._shouldReconnect=!1),this._connect(),this._handleOpen=this._handleOpen.bind(this),this._handleClose=this._handleClose.bind(this),this._handleMessage=this._handleMessage.bind(this),this._handleError=this._handleError.bind(this)}static get CONNECTING(){return 0}static get OPEN(){return 1}static get CLOSING(){return 2}static get CLOSED(){return 3}get CONNECTING(){return g.CONNECTING}get OPEN(){return g.OPEN}get CLOSING(){return g.CLOSING}get CLOSED(){return g.CLOSED}get readyState(){return this._ws?this._ws.readyState:this._options.startClosed?g.CLOSED:g.CONNECTING}get url(){return this._ws?this._ws.url:""}close(e=1e3,t){this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws&&this._ws.readyState!==this.CLOSED&&this._ws.close(e,t)}reconnect(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()}send(e){if(this._ws&&this._ws.readyState===this.OPEN)this._ws.send(e);else{const{maxEnqueuedMessages:t=u.maxEnqueuedMessages}=this._options;this._messageQueue.length<t&&this._messageQueue.push(e)}}addEventListener(e,t){this._listeners[e]&&this._listeners[e].push(t)}dispatchEvent(e){const t=this._listeners[e.type];if(t)for(const s of t)this._callEventListener(e,s);return!0}removeEventListener(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((e=>e!==t)))}_getNextDelay(){const{reconnectionDelayGrowFactor:e=u.reconnectionDelayGrowFactor,minReconnectionDelay:t=u.minReconnectionDelay,maxReconnectionDelay:s=u.maxReconnectionDelay}=this._options;let i=0;return this._retryCount>0&&(i=t*Math.pow(e,this._retryCount-1),i>s&&(i=s)),i}_wait(){return new Promise((e=>{setTimeout(e,this._getNextDelay())}))}_getNextUrl(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){const t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")}_connect(){if(this._connectLock||!this._shouldReconnect)return;this._connectLock=!0;const{maxRetries:e=u.maxRetries,connectionTimeout:t=u.connectionTimeout,WebSocket:s=d()}=this._options;if(!(this._retryCount>=e)){if(this._retryCount++,this._removeListeners(),void 0===(i=s)||!i||2!==i.CLOSING)throw Error("No valid WebSocket class provided");var i;this._wait().then((()=>this._getNextUrl(this._url))).then((e=>{this._closeCalled?this._connectLock=!1:(this._ws=this._protocols?new s(e,this._protocols):new s(e),this._ws.binaryType=this._binaryType,this._connectLock=!1,this._addListeners(),this._connectTimeout=setTimeout((()=>this._handleTimeout()),t))})).catch((e=>{this._connectLock=!1,this._handleError(new c(Error(e.message),this))}))}}_handleTimeout(){this._handleError(new c(Error("TIMEOUT"),this))}_disconnect(e=1e3,t){if(this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new l(e,t,this))}catch(e){}}}_acceptOpen(){this._retryCount=0}_callEventListener(e,t){"handleEvent"in t?t.handleEvent(e):t(e)}_handleOpen(e){const{minUptime:t=u.minUptime}=this._options;clearTimeout(this._connectTimeout),this._uptimeTimeout=setTimeout((()=>this._acceptOpen()),t),this._ws.binaryType=this._binaryType,this._messageQueue.forEach((e=>this._ws.send(e))),this._messageQueue=[],this.onopen&&this.onopen(e),this._listeners.open.forEach((t=>this._callEventListener(e,t)))}_handleMessage(e){this.onmessage&&this.onmessage(e),this._listeners.message.forEach((t=>this._callEventListener(e,t)))}_handleError(e){this._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),this.onerror&&this.onerror(e),this._listeners.error.forEach((t=>this._callEventListener(e,t))),this._connect()}_handleClose(e){this._clearTimeouts(),this._shouldReconnect&&this._connect(),this.onclose&&this.onclose(e),this._listeners.close.forEach((t=>this._callEventListener(e,t)))}_removeListeners(){this._ws&&(this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))}_addListeners(){this._ws&&(this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))}_clearTimeouts(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)}}var f=s(424);const p="__PROXY_IDENTIFIER__";const m=64e3;function _(){return!0}function S(){return Date.parse(new Date)/1e3}function y(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}function v(e,t,s,i=2e3,n=!1){const r=new XMLHttpRequest;let o=e;return n&&(o=function(e,t,s){const i=new URL(e);return i.searchParams.append(t,s),i.href}(e,p,!0)),t=t||"bytes=0-0",new Promise(((n,a)=>{r.open("GET",o,!0),r.responseType="arraybuffer",r.timeout=i,r.onreadystatechange=e=>{if(4===r.readyState){const e=r.status;206===e||200===e&&t?n(r.response):a(`status ${e} url ${o} range ${t}`)}},r.onerror=e=>{a("request error")},r.ontimeout=e=>{a("timeout")},r.setRequestHeader("Range",t),s&&s(r,e),r.send()}))}function C(e,t){return new Promise(((s,i)=>setTimeout((()=>{i(t)}),e)))}function w(){if("object"!=typeof self)return null;var e={RTCPeerConnection:self.RTCPeerConnection||self.mozRTCPeerConnection||self.webkitRTCPeerConnection,RTCSessionDescription:self.RTCSessionDescription||self.mozRTCSessionDescription||self.webkitRTCSessionDescription,RTCIceCandidate:self.RTCIceCandidate||self.mozRTCIceCandidate||self.webkitRTCIceCandidate};return e.RTCPeerConnection&&e.RTCPeerConnection.prototype?e:null}function P(){return location.protocol.startsWith("https")}function b(e){return e instanceof ArrayBuffer&&0!==e.byteLength}function E(){let e=new Date,t=e.getHours(),s=e.getMinutes(),i=e.getSeconds(),n=e.getMilliseconds();return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}.${n}`}function I(e){return e&&"function"==typeof e}function T(e,t,s){return 1===e.length?t.length>=1&&s.length>=1?t[0].weight>s[0].weight?[t[0],e[0]]:[e[0],s[0]]:t.length>=1?[t[0],e[0]]:s.length>=1?[e[0],s[0]]:(i=e[0],0===y(0,1)?[null,i]:[i,null]):[t.length>=1?t[0]:null,s.length>=1?s[0]:null];var i}class A extends(a()){constructor(e,t){super(),this.logger=e,t.startsWith("wss")?this.addr=t.replace("wss","https"):t.startsWith("ws")&&(this.addr=t.replace("ws","http")),this.connected=!1,this.retryCount=0,this.closed=!1,this.msgQueue=[],this.posting=!1}start(){this.closed=!1,this._hello((()=>{this._longPolling()}))}_hello(e){fetch(this.addr+"&hello",{method:"POST"}).then((e=>{if(!e.ok)throw new Error("hello response was not ok");return e.json()})).then((t=>{this.connected=!0,e(),this.onopen&&this.onopen(t.ver)})).catch((e=>{this.closed=!0,this.onerror&&this.onerror(e)}))}send(e){this.msgQueue.push(e),this.posting||this._realSend([...this.msgQueue])}_realSend(e){0!==e.length&&(this.posting=!0,this.msgQueue=[],fetch(this.addr,{method:"POST",body:JSON.stringify(e)}).then((()=>{this.posting=!1,this.msgQueue.length>0&&this._realSend([...this.msgQueue])})).catch((e=>{this.logger.error(e),this.posting=!1})))}close(){this.connected&&(this.closed=!0,this.connected=!1,this.abortController&&(this.abortController.abort(),this.abortController=null),this.onclose&&this.onclose())}destroy(){this.close(),this.removeAllListeners()}_longPolling(){if(this.closed)return;this.abortController=new AbortController;const e=this.abortController.signal;fetch(this.addr,{signal:e}).then((e=>{if(!e.ok)throw new Error("polling response was not ok");return e.text()})).then((e=>{e&&this.onmessage&&this.onmessage(JSON.parse(e)),this.retryCount=0,this._longPolling()})).catch((e=>{this.connected&&(this.retryCount<=3?(this.retryCount++,this._longPolling()):(this.connected=!1,this.onerror&&this.onerror(e)))}))}}const R=class{constructor(e,t,s,i="main"){this.logger=e,this.config=t,this.wsAddr=s,this.serverVersion=0,this.pingInterval=95e3,this.name=i,this.normalClosed=!1,this.lastSendTs=performance.now(),this.pollingClient=new A(e,s);try{this._ws=this._init()}catch(t){e.error(t),this._startPolling()}}get batchSupported(){return this.serverVersion>=50}_init(){const e={maxRetries:this.config.wsMaxRetries,minReconnectionDelay:y(15e3,6e4),maxReconnectionDelay:6e5,maxEnqueuedMessages:20,connectionTimeout:7e3};let t=new g(this.wsAddr,void 0,e);return t.addEventListener("open",(()=>{this.logger.info(`signal ${this.name} ${this.wsAddr} connection opened`),this.normalClosed=!1,this.pollingClient.connected?this.pollingClient.close():this.onopen&&this.onopen(),this._startPing(this.pingInterval)})),t.push=t.send,t.send=e=>{this.lastSendTs=performance.now();let s=JSON.stringify(e);t.push(s)},t.addEventListener("message",(e=>{let t=e.data;const s=JSON.parse(t),i=s.action;if("pong"!==i){if("ver"!==i)return"close"===i?(this.logger.warn(`server close signal ${this.name} reason ${s.reason}`),void this.close()):void(this.onmessage&&this.onmessage(s,this.name));this.serverVersion=s.ver}else clearTimeout(this.pongTimer)})),t.addEventListener("close",(e=>{this.logger.warn(`signal ${this.name} ${this.wsAddr} closed ${e.code} ${e.reason}`),e.code>=5e3||e.code<4e3?(this.onclose&&this.onclose(),this._stopPing()):this.close()})),t.addEventListener("error",(e=>{this._stopPing(),this.onerror&&this.onerror(e),this._startPolling()})),t}forcePolling(){this.pollingClient.connected||(this.close(),this.pollingClient=new A(this.logger,this.wsAddr),this._startPolling())}_startPolling(){this.pollingClient.connected||(this.logger.info(`${this.name} start polling`),this.pollingClient.start(),this._setupPolling(this.pollingClient))}sendDebug(e,t,s){this._send({action:"debug",details:t,ping:s||void 0,to:e})}sendSignal(e,t){const s={action:"signal",to:e,data:t};this._send(s)}sendSignalBatch(e,t){if(this.batchSupported&&t.length>1)this._send({action:"signals",to:e,data:t});else for(let s of t)this.sendSignal(e,s)}sendReject(e,t,s){if(this.rejectIdCache===e)return;this.rejectIdCache=e;const i={action:"reject",to:e,reason:t,fatal:s};this._send(i)}_send(e){this.pollingClient.connected?this.pollingClient.send(e):this._ws&&this._ws.send(e)}_startPing(e){this.connected&&(this.pingTimer=setTimeout((()=>{const e=95e3-(performance.now()-this.lastSendTs);if(e>=0)return this._startPing(e);const t={action:"ping"};this._ws&&this._ws.push(JSON.stringify(t)),this.pongTimer=setTimeout((()=>{this.logger.warn(`signal ${this.name} wait for pong timeout, reconnect`),this.close(),this.reconnect()}),15e3),this._startPing(this.pingInterval)}),e))}_stopPing(){clearTimeout(this.pingTimer),clearTimeout(this.pongTimer)}close(){this.logger.info(`close signal ${this.name}`),this._stopPing(),(()=>{this._ws&&this._ws.close(1e3)})(),this.pollingClient.close(),this.normalClosed=!0}reconnect(){this._ws&&(this.logger.info(`reconnect signal ${this.name}`),this._ws.reconnect())}destroy(){this.close(),this._ws=null,this.pollingClient.destroy()}get connected(){return!!this.pollingClient.connected||this._connected}get _connected(){return!!this._ws&&this._ws.readyState===g.OPEN}_setupPolling(e){e.onopen=e=>{e&&(this.serverVersion=e),this.logger.info(`${this.name} polling opened`),this.onopen&&this.onopen()},e.onerror=e=>{this._connected||this.onerror&&this.onerror(e)},e.onclose=()=>{this._connected||this.onclose&&this.onclose()},e.onmessage=e=>{if(this.onmessage)for(let t of e)this.onmessage(t,this.name)}}},D=class{constructor(e,t,s,i){this.logger=e,this.config=t,this.mainAddr=s,this.backupAddr=i,this.mainWS=this._init(s),this.backupTimer=setTimeout((()=>{this.destroyed||(this.backupWS=this._init(i,"backup"))}),900),this._connected=!1,this.destroyed=!1,this.normalClosed=!1}_init(e,t){if(!e)return null;let s=new R(this.logger,this.config,e,t);return s.onopen=()=>{this.normalClosed=!1,!this._connected&&this.onopen&&(this._connected=!0,this.onopen())},s.onmessage=e=>{this.onmessage&&this.onmessage(e,s.name)},s.onclose=()=>{this._connected&&!this.connected&&this.onclose&&(this._connected=!1,this.onclose())},s.onerror=e=>{this.onerror&&this.onerror(e)},s}sendSignalBatch(e,t,s){if(s){const i=this._getWSByName(s);i&&i.sendSignalBatch(e,t)}else this.mainConnected?this.mainWS.sendSignalBatch(e,t):this.backupConnected&&this.backupWS.sendSignalBatch(e,t)}sendSignal(e,t,s){this.sendSignalBatch(e,[t],s)}sendReject(e,t,s,i){if(i){const n=this._getWSByName(i);if(n)return void n.sendReject(e,t,s)}this.mainConnected?this.mainWS.sendReject(e,t,s):this.backupConnected?this.backupWS.sendReject(e,t,s):this.logger.warn("no signal available, send reject failed")}sendDebug(e,t,s){this.mainConnected&&this.mainWS.sendDebug(e,t,s)}close(){this.mainWS&&this.mainWS.close(),this.backupWS&&this.backupWS.close(),this.normalClosed=!0}_getWSByName(e){return this.mainWS&&this.mainWS.name===e?this.mainWS:this.backupWS&&this.backupWS.name===e?this.backupWS:null}reconnect(e){this.mainWS&&"backup"!==e&&this.mainWS.reconnect(),this.backupWS&&"main"!==e&&this.backupWS.reconnect()}forcePolling(e){this.mainWS&&"backup"!==e&&this.mainWS.forcePolling(),this.backupWS&&"main"!==e&&this.backupWS.forcePolling()}destroy(){this.close(),clearTimeout(this.backupTimer),this.mainWS=null,this.backupWS=null,this.destroyed=!0}get connected(){return this.mainConnected||this.backupConnected}get mainConnected(){return this.mainWS&&this.mainWS.connected}get backupConnected(){return this.backupWS&&this.backupWS.connected}};function M(e,t){for(const s in t)Object.defineProperty(e,s,{value:t[s],enumerable:!0,configurable:!0});return e}const L=function(e,t,s){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");s||(s={}),"object"==typeof t&&(s=t,t=void 0),null!=t&&(s.code=t);try{return M(e,s)}catch(t){s.message=e.message,s.stack=e.stack;const i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(e)),M(new i,s)}},k={DC_SIGNAL:"SIGNAL",DC_SIGNAL_BATCH:"SIGNAL_BATCH",DC_OPEN:"OPEN",DC_REQUEST:"REQUEST",DC_PIECE_NOT_FOUND:"PIECE_NOT_FOUND",DC_PIECE_ABORT:"PIECE_ABORT",DC_PIECE_CANCEL:"PIECE_CANCEL",DC_CLOSE:"CLOSE",DC_DISCONNECT:"DISCONNECT",DC_RESPONSE:"RESPONSE",DC_ERROR:"ERROR",DC_PIECE:"PIECE",DC_PIECE_DATA:"PIECE_DATA",DC_TIMEOUT:"TIMEOUT",DC_PIECE_ACK:"PIECE_ACK",DC_METADATA:"METADATA",DC_PLAT_ANDROID:"ANDROID",DC_PLAT_IOS:"IOS",DC_PLAT_WEB:"WEB",DC_CHOKE:"CHOKE",DC_UNCHOKE:"UNCHOKE",DC_HAVE:"HAVE",DC_HAVE_REVERSE:"HAVE_REVERSE",DC_LOST:"LOST",DC_GET_PEERS:"GET_PEERS",DC_PEERS:"PEERS",DC_STATS:"STATS",DC_PEER_SIGNAL:"PEER_SIGNAL",DC_PLAYLIST:"PLAYLIST",BM_LOST:"lost",BM_ADDED_SEG_:"BM_ADDED_SEG_",BM_ADDED_SN_:"BM_ADDED_SN_",BM_SEG_ADDED:"BM_SEG_ADDED",BM_FATAL_ERROR:"BM_FATAL_ERROR",FRAG_CHANGED:"FRAG_CHANGED",FRAG_LOADED:"FRAG_LOADED",FRAG_LOADING:"FRAG_LOADING",RESTART_P2P:"RESTART_P2P",EXCEPTION:"exception",SYN_OUTPUT:"SYN_OUTPUT",SYN_ERROR:"SYN_ERROR",SYN_PROGRESS:"SYN_PROGRESS",MEDIA_REBUFFER:"MEDIA_REBUFFER"};const N=function(e,t,s=40){var i=null,n=!1,r=s;return function(s=!1){if(s)return clearTimeout(i),void(n=!1);n||(n=!0,i=setTimeout((function(){e.call(t,r),n=!1,i=null}),1e3*r),r*=1.1)}};let $;const O="function"==typeof queueMicrotask?queueMicrotask.bind(globalThis):e=>($||($=Promise.resolve())).then(e).catch((e=>setTimeout((()=>{throw e}),0))),B=65536;function q(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}class x extends(a()){constructor(e){super(),this.channelName=e.initiator?e.channelName:null,this.initiator=e.initiator||!1,this.channelConfig=e.channelConfig||x.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},x.config,e.config),this.offerOptions=e.offerOptions||{},this.answerOptions=e.answerOptions||{},this.sdpTransform=e.sdpTransform||(e=>e),this.trickle=void 0===e.trickle||e.trickle,this.allowHalfTrickle=void 0!==e.allowHalfTrickle&&e.allowHalfTrickle,this.iceCompleteTimeout=e.iceCompleteTimeout||5e3,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=w(),this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._pendingData=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._senderMap=new Map,this._closingInterval=null,this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(e){return void O((()=>this.destroy(e)))}this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this._needsNegotiation()}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}signal(e){if(!this.destroyed&&this._pc){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}if(e.renegotiate&&this.initiator&&this._needsNegotiation(),e.candidate)if(this._pc.remoteDescription&&this._pc.remoteDescription.type)try{this._addIceCandidate(e.candidate)}catch(e){}else this._pendingCandidates.push(e.candidate);e.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{try{this._addIceCandidate(e)}catch(e){}})),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{e.debug=!0,this.destroy(e)})),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.destroy(new Error("signal() called with invalid signal data"))}}_addIceCandidate(e){const t=new this._wrtc.RTCIceCandidate(e);this._pc.addIceCandidate(t).catch((e=>{var s;!t.address||t.address.endsWith(".local")?(s="Ignoring unsupported ICE candidate.",console.warn(s)):(e.debug=!0,this.destroy(e))}))}send(e){if("string"==typeof e){RTCDataChannel.prototype.send.toString().includes("[native code]")&&this._channel.send(e)}else this._channel.send(e)}_needsNegotiation(){this._batchedNegotiation||(this._batchedNegotiation=!0,O((()=>{this._batchedNegotiation=!1,!this.initiator&&this._firstNegotiation||this.negotiate(),this._firstNegotiation=!1})))}negotiate(){this.initiator?this._isNegotiating?this._queuedNegotiation=!0:setTimeout((()=>{this._createOffer()}),0):this._isNegotiating?this._queuedNegotiation=!0:this.emit("signal",{type:"renegotiate",renegotiate:!0}),this._isNegotiating=!0}destroy(e){this._destroy(e)}_destroy(e){this.destroyed||this.destroying||(this.destroying=!0,O((()=>{if(this.destroyed=!0,this.destroying=!1,this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,e&&this.emit("error",e),this.emit("close")})))}_setupData(e){if(!e.channel)return this.destroy(new Error("Data channel event is missing `channel` property"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=B),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=e=>{e.debug=!0,this.destroy(e)};let t=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1}),5e3)}get isBufferedAmountHigh(){return this._channel.bufferedAmount>B}write(e,t){if(this.destroyed)return t(new Error("cannot write after peer is destroyed"));if(this._connected){try{this.send(e)}catch(e){return this.destroy(e)}this.isBufferedAmountHigh?this._cb=t:t(null)}else this._chunk=e,this._cb=t}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=q(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(e)}))})).catch((e=>{this.destroy(e)}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=q(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.destroy(e)}))})).catch((e=>{this.destroy(e)}))}_onConnectionStateChange(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(new Error("Connection failed."))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.destroy(new Error("Ice connection failed.")),"closed"===e&&this.destroy(new Error("Ice connection closed."))}getStats(e){const t=e=>("[object Array]"===Object.prototype.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length?this._pc.getStats().then((s=>{const i=[];s.forEach((e=>{i.push(t(e))})),e(null,i)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((s=>{if(this.destroyed)return;const i=[];s.result().forEach((e=>{const s={};e.names().forEach((t=>{s[t]=e.stat(t)})),s.id=e.id,s.type=e.type,s.timestamp=e.timestamp,i.push(t(s))})),e(null,i)}),(t=>e(t))):e(null,[])}_maybeReady(){if(this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this.getStats(((t,s)=>{if(this.destroyed)return;t&&(s=[]);const i={},n={},r={};let o=!1;s.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(i[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(n[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(r[e.id]=e)}));const a=e=>{o=!0;let t=n[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let s=i[e.remoteCandidateId];s&&(s.ip||s.address)?(this.remoteAddress=s.ip||s.address,this.remotePort=Number(s.port)):s&&s.ipAddress?(this.remoteAddress=s.ipAddress,this.remotePort=Number(s.portNumber)):"string"==typeof e.googRemoteAddress&&(s=e.googRemoteAddress.split(":"),this.remoteAddress=s[0],this.remotePort=Number(s[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4")};if(s.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&a(r[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&a(e)})),o||Object.keys(r).length&&!Object.keys(n).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.destroy(t)}this._chunk=null;const e=this._cb;this._cb=null,e(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this.emit("connect");for(let e of this._pendingData)this.emit("data",e);this._pendingData=[]}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>B||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._queuedNegotiation?(this._queuedNegotiation=!1,this._needsNegotiation()):this.emit("negotiated")),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;t instanceof ArrayBuffer&&(t=f.h.from(t)),this._connected?this.emit("data",t):this._pendingData.length<10&&this._pendingData.push(t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||this.destroy()}}x.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},x.channelConfig={};const W=x;class F{constructor(e,t,s,i,n=0,r=void 0){this.sn=e,this.segId=t,this.data=s,this.fromPeerId=i,this.level=n||0,this.ext=r}static fromSegment(e){const t=new F(e.sn,e.segId,e.data,e.fromPeerId,e.level,e.ext);return t.from=e.from,t}get size(){return this.data.byteLength}get isSequential(){return this.sn>=0}}var z=s(365),U=s.n(z);class j extends(a()){static get defaultPacketSize(){return m}static get VERSION(){return"8"}constructor(e,t,s,i,n,r={}){super(),this.channel=e.fetcher.channelId,this.logger=e.logger,this.config=n,this.isInitiator=i,this.options=r,this.intermediator=r.intermediator||null,this.signalMsgs=[],this.assignPeerId(t,s),this.platform="unknown",this.super=!1,this.mobile=!1,this.mobileWeb=!1,this.mobileNet=!1,this.connected=!1,this.msgQueue=[],this.miss=0,this.notifySet=new Set,this.bufArr=[],this.packetSize=m,this.sendReqQueue=[],this.downloading=!1,this.uploading=!1,this.choked=!1,this.streamListeners=[],this.pieceMsg={},this.datasToSend=[],this.bytesUploaded=0,this.dataWriting=!1,this.timeSendRequest=0,this.timeReceivePiece=0,this.timeSendPiece=0,this.weight=0,this.peersConnected=1,this.uploadSpeed=0,this.currentLevel=0,this.currentPos=0,this.useBackupSignal=!1,this.gotPeersTS=0,this.gotAnswer=!1,this.gotOffer=!1,this.gotSignal=!1,this.sentSignal=!1,this.incomingSignal=[],this.webRTCConfig={};const{stuns:o}=this.options;if(o&&o.length>0){const e=[];o.forEach((t=>{this.logger.info(`use stun ${t}`),e.push({urls:t})})),this.webRTCConfig.iceServers=e}this.config.webRTCConfig&&(this.webRTCConfig={...this.config.webRTCConfig,...this.webRTCConfig}),this.playlistMap=new Map,this._initPeerChannel(),this.notFatalClosed=!1,this.startSN=Number.MAX_SAFE_INTEGER,this.endSN=-1,this._loadedBytes=0}assignPeerId(e,t){this.remotePeerId=t,this.channelId=this.isInitiator?`${e}-${t}`:`${t}-${e}`,t&&this._startTimer(),setTimeout((()=>{this.signalMsgs.length>0&&this.emit(k.DC_SIGNAL_BATCH,this.signalMsgs)}),0)}_startTimer(){this.timeJoin=S(),this.dataExchangeTs=this.timeJoin,this.gotStatsTs=this.timeJoin,this.connTimeout=setTimeout((()=>{const{gotSignal:e,sentSignal:t,signalName:s}=this;this.logger.warn(`dc ${this.channelId} connection timeout, gotSignal ${e} sentSignal ${t} signalName ${s}`),this.emit(k.DC_TIMEOUT,{gotSignal:e,sentSignal:t,data:this.signalMsgs})}),this.isInitiator?15e3:12e3)}get isAvailable(){return this.downloadNum<2&&!this.choked}get isAvailableUrgently(){return!this.downloading&&!this.choked}cancelDownload(e,t,s){return!!this.downloading&&(!(this.bufSN>e)&&(!(this.streamListeners.length>0)&&(this.logger.info(`cancel download ${s} to ${this.remotePeerId} remain packets ${this.remainAttachments}`),this.timeReceivePiece=0,this.sendJson({event:k.DC_PIECE_CANCEL,sn:e,level:t,seg_id:s}))))}addStreamListener(e,t,s){this.streamListeners.push({handler:s,peerId:t})}removeStreamListener(e){this.streamListeners=this.streamListeners.filter((t=>t.peerId!==e||(t.handler(void 0,void 0,!0,"aborted by cancel"),!1)))}_initPeerChannel(){const e=new W({initiator:this.isInitiator,trickle:this.options.trickle||!1,config:this.webRTCConfig});this._datachannel=e,e.on("error",(e=>{let t=!0;(this.connected||this.notFatalClosed)&&(t=!1);let s=e.message;e.debug&&(s=`${s} raw: ${JSON.stringify(this.incomingSignal)}`),this.emit(k.DC_ERROR,t,s)})),e.on("signal",(e=>{e.candidate&&!e.candidate.candidate||(!this.useBackupSignal&&this.signalMsgs.length<10&&this.signalMsgs.push(e),this.sentSignal=!0,this.emit(k.DC_SIGNAL,e))}));e.on("connect",(()=>{for(this.logger.info(`datachannel CONNECTED from ${this.intermediator?"peer":"server "+this.signalName} to ${this.remotePeerId}`),this.connected=!0,this.incomingSignal=[],clearTimeout(this.connTimeout),this.signalMsgs=[],this.emit(k.DC_OPEN);this.msgQueue.length>0;){let e=this.msgQueue.shift();this.emit(e.event,e)}})),e.on("data",(e=>{const{logger:t}=this;if("string"==typeof e){let s=JSON.parse(e);if(!s)return void t.error("dc received string is null");if(!this.connected)return void this.msgQueue.push(s);let i,n=s.event;switch(i=n!==k.DC_PLAYLIST&&n!==k.DC_PEER_SIGNAL?`string: ${e}`:`event: ${n}`,t.debug(`datachannel receive ${i} from ${this.remotePeerId}`),n){case k.DC_HAVE:if(this.emit(s.event,s),!s.sn)return;this.config.live||(s.sn<this.startSN&&(this.startSN=s.sn),s.sn>this.endSN&&(this.endSN=s.sn));break;case k.DC_PIECE:this.downloading=!0,this.dataExchangeTs=S(),this.timeReceivePiece=performance.now(),this.pieceMsg=s,this._prepareForBinary(s.attachments,s.seg_id,s.sn,s.size),this.emit(s.event,s);break;case k.DC_PIECE_CANCEL:t.info(`send queue ${this.datasToSend.length}, uploading ${this.uploading}`),this.emit(s.event,s),this.sendMsgPieceAbort("transfer canceled",s.seg_id);break;case k.DC_PIECE_NOT_FOUND:this._sendNextReq()||(this.downloading=!1),this.emit(s.event,s);break;case k.DC_REQUEST:this._handleRequestMsg(s);break;case k.DC_PIECE_ACK:this._handlePieceAck(s.seg_id,s.size,s.miss);break;case k.DC_STATS:this._handleStats(s);break;case k.DC_PLAYLIST:this.config.sharePlaylist&&this._handlePlaylist(s);break;case k.DC_METADATA:this._handleMetadata(s);break;case k.DC_PIECE_ABORT:this.downloading&&(this._notifyDownloadListenersAbort("aborted by upstream peer"),this.emit(k.DC_PIECE_ABORT,s)),this.downloading=!1,this.segId=void 0;break;case k.DC_CHOKE:t.info(`choke peer ${this.remotePeerId}`),this.choked=!0;break;case k.DC_UNCHOKE:t.info(`unchoke peer ${this.remotePeerId}`),this.choked=!1;break;case k.DC_CLOSE:this.emit(s.event,s.fatal||!1);break;default:this.emit(s.event,s)}}else{if(!e)return void t.error("datachannel on data is undefined!");if(!this.downloading){const s=`peer ${this.remotePeerId} not downloading, data size ${e.byteLength} pieceMsg ${JSON.stringify(this.pieceMsg)}`;return t.warn(s),void this.emit(k.DC_ERROR,!1,s)}this._handleBinaryMsg(e)}})),e.once("close",(()=>{this.emit(k.DC_CLOSE,!1)})),e.on("iceStateChange",((e,t)=>{this.connected&&"disconnected"===e&&(this.logger.warn(`${this.remotePeerId} disconnected`),this.emit(k.DC_DISCONNECT))}))}sendJson(e){if(!this.remotePeerId)return!1;e.event!==k.DC_PLAYLIST&&e.event!==k.DC_PEER_SIGNAL?this.logger.debug(`dc bufferSize ${this._datachannel.bufferSize} send ${JSON.stringify(e)} to ${this.remotePeerId}`):this.logger.debug(`dc send event ${e.event} to ${this.remotePeerId}`);const t=JSON.stringify(e);return t.length>m?(this.logger.error("string to send is too large"),!1):this.send(t,!1)}send(e,t=!0){return t?(this.datasToSend.push(e),this.dataWriting||this._sendDataSync(),!0):this.sendImmediately(e)}_sendDataSync(){if(!this._datachannel.connected||0===this.datasToSend.length)return void(this.dataWriting=!1);this.dataWriting=!0;const e=this.datasToSend.shift();e?("string"!=typeof e&&(this.bytesUploaded+=e.byteLength),this._datachannel.write(e,(e=>{if(e)return this.dataWriting=!1,void this.emit(k.DC_ERROR,!1,e.message);this._sendDataSync()}))):this.logger.error("sendDataSync data is undefined!")}sendImmediately(e){if(this._datachannel.connected)try{return this._datachannel.send(e),!0}catch(e){const t=`datachannel ${this.channelId} send data failed, close it`;this.emit(k.DC_ERROR,!1,t)}return!1}sendMsgHave(e,t,s={}){const i=s.reverse||void 0;delete s.reverse,this.sendJson({event:i?k.DC_HAVE_REVERSE:k.DC_HAVE,sn:e,seg_id:t,...s})}sendPieceNotFound(e,t,s={}){this.uploading=!1,this.sendJson({event:k.DC_PIECE_NOT_FOUND,seg_id:t||void 0,sn:e,...s})}sendPeers(e){this.sendJson({event:k.DC_PEERS,peers:e})}sendPeersRequest(){this.sendJson({event:k.DC_GET_PEERS})}sendMsgStats(e,t={}){const s={event:k.DC_STATS,total_conns:e,...t};this.sendJson(s)}sendMsgPlaylist(e,t,s){const i=this.playlistMap.get(e);if(i&&i.seq>=s)return;const n={event:k.DC_PLAYLIST,url:e,data:t,seq:s};this.playlistMap.set(e,{data:t,seq:s}),this.sendJson(n)}sendMsgSignal(e,t,s){return this.sendJson({event:k.DC_PEER_SIGNAL,action:"signal",to_peer_id:e,from_peer_id:t,data:s})}sendMsgSignalReject(e,t,s,i=!1){return this.sendJson({event:k.DC_PEER_SIGNAL,action:"reject",to_peer_id:e,from_peer_id:t,reason:s,fatal:i})}sendMetaData(e,t,s,i,n=!1){this.isInitiator&&(this.timeSendRequest=performance.now()),this.sendJson({event:k.DC_METADATA,field:e,platform:k.DC_PLAT_WEB,mobile:!!U().isMobile(),mobile_net:n,channel:this.channel,version:"1.2.0",sequential:t,peers:s,region:i})}sendPartialBuffer(e,t,s={}){if(!this.sendMsgPiece(e,s))return!1;for(let e=0;e<t.length;e++)this.send(t[e]);return!0}sendMsgPiece(e,t={}){if(!this.uploading)return this.logger.info("not uploading, cancel send buffer"),!1;this.datasToSend=[],this.bytesUploaded=0,e.ext||(e.ext={}),e.ext.from&&t.from&&t.from.length<2500&&(t.from=`${e.ext.from}-${t.from}`),t.incompletes&&e.ext.incompletes&&(t.incompletes+=e.ext.incompletes),t=Object.assign({},e.ext,t);const s={...e,ext:t};return this.sendJson(s)}sendBuffer(e,t,s,i={}){const n=i.reverse||void 0;if(delete i.reverse,!s)return void this.logger.error("sendBuffer payload is undefined!");let r=s.byteLength,o=0,a=0;r%this.packetSize==0?a=r/this.packetSize:(a=Math.floor(r/this.packetSize)+1,o=r%this.packetSize);let h={event:k.DC_PIECE,attachments:a,seg_id:t,sn:e,level:i.level,size:r,reverse:n};if(delete i.level,!this.sendMsgPiece(h,i))return;const c=function(e,t,s,i){let n=[];if(i){let r;for(let i=0;i<s-1;i++)r=e.slice(i*t,(i+1)*t),n.push(r);r=e.slice(e.byteLength-i,e.byteLength),n.push(r)}else{let i;for(let r=0;r<s;r++)i=e.slice(r*t,(r+1)*t),n.push(i)}return n}(s,this.packetSize,a,o);this._sendBufferArray(c,n),this.uploading=!1,this.timeSendPiece=performance.now()}get downloadNum(){return this.downloading?this.sendReqQueue.length+1:0}requestDataById(e,t,s=!1,i={}){const n={event:k.DC_REQUEST,seg_id:e,sn:t,...i,urgent:s};this.downloading?(this.logger.info(`${this.remotePeerId} add req ${e} in queue`),s?this.sendReqQueue.unshift(n):this.sendReqQueue.push(n)):this._realRequestData(n)}requestDataBySN(e,t=!1,s={}){const i={event:k.DC_REQUEST,sn:e,...s,urgent:t};this.downloading?(this.logger.info(`add req ${e} in queue`),t?this.sendReqQueue.unshift(i):this.sendReqQueue.push(i)):this._realRequestData(i)}_sendBufferArray(e,t=!1){const s=t?e.reverse():e;for(let e=0;e<s.length;e++)this.send(s[e])}_realRequestData(e){this.sendJson(e),this.timeSendRequest=performance.now(),this.downloading=!0,this._loadedBytes=0}shouldWaitForRemain(e){return 0!==this.bufArrSize&&(0!==this.timeReceivePiece&&this.currentLoadSpeed()>=this.minRequiredSpeed(e))}close(e){e||(this.notFatalClosed=!0),this.emit(k.DC_CLOSE,e)}receiveSignal(e,t){if("answer"===e.type){if(this.gotAnswer||this.gotOffer)return;this.gotAnswer=!0}else if("offer"===e.type){if(this.gotOffer||this.gotAnswer)return;this.gotOffer=!0}this.gotSignal=!0,t&&this.incomingSignal.push(t),e&&this._datachannel.signal(e)}_notifyDownloadListenersAbort(e){for(let t of this.streamListeners){const{handler:s}=t;s(void 0,void 0,!0,e)}this.streamListeners=[]}destroy(e=!0){this.logger.info(`destroy datachannel ${this.channelId}`),clearTimeout(this.chokeTimer),clearTimeout(this.connTimeout),this._notifyDownloadListenersAbort("upstream peer is closed");let t={event:k.DC_CLOSE,fatal:e};this.sendJson(t),this._datachannel.removeAllListeners(),this.removeAllListeners(),this._datachannel.destroy()}_handleBinaryMsg(e){const{attachments:t,reverse:s}=this.pieceMsg;this.listenerCount(k.DC_RESPONSE)>0&&this.bufArr.push(e),this._loadedBytes+=e.byteLength,this.remainAttachments--;let i=s?this.remainAttachments+1:t-this.remainAttachments;const n=0===this.remainAttachments;if(this.emit(k.DC_PIECE_DATA,this.bufSN,this.segId,e,i,n,this.pieceMsg),this.streamListeners.length>0)for(let t of this.streamListeners){const{handler:s}=t;s(this.bufSN,this.segId,!1,e,n)}if(n){if(this.streamListeners=[],this.timeSendRequest>0)if(this.super)this.weight=1;else{const e=this.expectedSize/(performance.now()-this.timeSendRequest);this.weight=this.weight>0?.6*this.weight+.4*e:e}this.sendJson({event:k.DC_PIECE_ACK,seg_id:this.segId,size:this.expectedSize,miss:this.miss||void 0}),this.timeSendRequest=0,this.timeReceivePiece=0,this._sendNextReq()||(this.downloading=!1),this._handleBinaryData(s)}}_sendNextReq(){if(this.sendReqQueue.length>0){const e=this.sendReqQueue.shift();return this.logger.info(`get msg from sendReqQueue ${JSON.stringify(e)}`),this._realRequestData(e),!0}return!1}_handlePlaylist(e){const{url:t,data:s,seq:i}=e;this.playlistMap.set(t,{data:s,seq:i})}getLatestPlaylist(e,t){if(!this.playlistMap.has(e))return null;const s=this.playlistMap.get(e);return s.seq<=t||s.seq>t+2?null:s}_handleMetadata(e){const{logger:t}=this;if(this.isInitiator){const e=performance.now()-this.timeSendRequest;e>0&&(this.weight=1e5/e,t.info(`handle Metadata from ${this.remotePeerId} initial weight ${this.weight}`)),this.timeSendRequest=0}const s=e.channel;if(this.channel!==s){const e=`peer channel ${s} not matched!`;return t.error(e),void this.emit(k.DC_ERROR,!0,e)}if(e.super){t.info(`got super peer ${this.remotePeerId}`),this.super=!0;const{token:s}=this.config;if(s&&e.token!==s)return void this.emit(k.DC_ERROR,!0,`super peer token ${e.token} not matched!`)}e.region&&(this.region=e.region);switch(e.platform){case k.DC_PLAT_ANDROID:this.platform=k.DC_PLAT_ANDROID;break;case k.DC_PLAT_IOS:this.platform=k.DC_PLAT_IOS;break;case k.DC_PLAT_WEB:this.platform=k.DC_PLAT_WEB}if(this.mobile=e.mobile||!1,this.mobileNet=e.mobile_net||!1,this.mobileWeb=this.mobile&&this.platform===k.DC_PLAT_WEB||!1,this.sequential=e.sequential,t.info(`${this.remotePeerId} platform ${this.platform} sequential ${this.sequential}`),e.peers&&(this.peersConnected+=e.peers,t.info(`${this.remotePeerId} now has ${this.peersConnected} peers`)),this.emit(k.DC_METADATA,e),e.field&&!this.config.live&&e.sequential){const{field:t}=e;if(Array.isArray(t))this._handleField(t);else for(let e in t)this._handleField(t[e])}}_handleField(e){e.forEach((e=>{e>=0&&(e<this.startSN&&(this.startSN=e),e>this.endSN&&(this.endSN=e))}))}_handleStats(e){this.gotStatsTs=S();const t=e.total_conns;t>0&&this.peersConnected!==t&&(this.peersConnected=t,this.logger.info(`${this.remotePeerId} now has ${this.peersConnected} peers`)),e.level&&(this.currentLevel=e.level),e.pos&&(this.currentPos=e.pos)}_handleRequestMsg(e){if(this.dataExchangeTs=S(),this.uploading)return this.logger.warn(`${this.remotePeerId} is uploading when receive request`),void this.sendPieceNotFound(e.sn,e.seg_id,{level:e.level});this.uploading=!0,this.emit(k.DC_REQUEST,e)}_handlePieceAck(e,t,s){0!==this.timeSendPiece&&(this.uploadSpeed=Math.round(t/(performance.now()-this.timeSendPiece)*2),this.timeSendPiece=0,this.logger.info(`${this.remotePeerId} uploadSpeed is ${this.uploadSpeed}`)),s>0&&this.logger.warn(`peer ${this.remotePeerId} miss ${s}`),this.bytesUploaded>0&&this.emit(k.DC_PIECE_ACK,{seg_id:e,size:t})}_prepareForBinary(e,t,s,i){this.bufArr=[],this._loadedBytes=0,this.remainAttachments=e,this.segId=t,this.bufSN=s,this.expectedSize=i}_handleBinaryData(e=!1){if(this.listenerCount(k.DC_RESPONSE)>0){e&&this.bufArr.reverse();let t=f.h.concat(this.bufArr);const s=t.byteLength;if(s===this.expectedSize){let e=t.buffer;const s=new F(this.bufSN,this.segId,e,this.remotePeerId,this.pieceMsg.level);this.emit(k.DC_RESPONSE,s,this.weight)}else this.logger.error(`${this.segId} expectedSize ${this.expectedSize} != byteLength ${s}`)}this.bufArr=[]}checkIfNeedChoke(e=!1){const{logger:t}=this,s=performance.now()-this.timeSendRequest;if((e||!(s<1e3))&&(this.miss++,t.info(`${this.remotePeerId} miss ${this.miss}`),this.miss>=3&&!this.choked)){this.choked=!0;const e=30*this.miss;e<=150?(t.warn(`datachannel ${this.channelId} is choked`),this.chokeTimer=setTimeout((()=>{this.choked=!1,t.warn(`datachannel ${this.channelId} is unchoked`)}),1e3*e)):t.warn(`datachannel ${this.channelId} is choked permanently`)}}get bufArrSize(){return this.downloading?this.pieceMsg.attachments-this.remainAttachments:0}loadtimeout(){const{logger:e,pieceMsg:t}=this;return e.warn(`timeout while downloading from ${this.remotePeerId}, ${this.bufArrSize} of ${t.attachments} packets loaded`),this.checkIfNeedChoke(),!0}sendMsgPieceAbort(e,t,s=!1){const i=this.datasToSend.length;if(!s&&!this.uploading&&0===i)return;this.uploading=!1,this.datasToSend=[],this._handlePieceAck(t,this.bytesUploaded,0),this.bytesUploaded=0;const n={event:k.DC_PIECE_ABORT,reason:`${e}, remains ${i}`};return this.sendJson(n)}loadedBytes(){return this._loadedBytes}currentLoadSpeed(){return 0===this.timeReceivePiece?0:this.loadedBytes()/(performance.now()-this.timeReceivePiece)}minRequiredSpeed(e){return(this.pieceMsg.size-this.loadedBytes())/e}}const G=j;class H{constructor(e,t,s=10){this.engine=e,this.config=t,this.trickle=t.trickleICE,this.poolSize=s,this.pool=[],t.ICEPreflight&&this.reset(),this.trickle=!1}reset(){this.destroy();for(let e=0;e<this.poolSize;e++)this.pool.push(this._createPeer())}_createPeer(){return new G(this.engine,void 0,void 0,!0,this.config,{trickle:this.trickle})}get available(){return 0!==this.pool.length&&this.pool[0].signalMsgs.length>0}getPeer(){if(0===this.pool.length)return this._createPeer();const e=this.pool.shift();return this.pool.length<5&&this.pool.push(this._createPeer()),e}destroy(){for(let e of this.pool)e.destroy(!0);this.pool=[]}}const J={debug:3,info:4,warn:5,error:6};class Q{constructor(e,t,s,i){this.wsAddr=`${e}?app=${t}&id=${s}&v=${i}`,this.destroyed=!1;try{this._ws=this._init()}catch(e){console.error(e)}}_init(){const e={maxRetries:3,minReconnectionDelay:y(5e3,15e3),maxReconnectionDelay:6e5,maxEnqueuedMessages:200};return new g(this.wsAddr,void 0,e)}send(e,t){if(this.destroyed)return;const s=J[e];this._ws.send(JSON.stringify({records:[{level:s,text:`${E()}: ${t}`}]}))}sendBatch(e){const t=[];for(let s of e)t.push({level:J[s.levelKey],text:s.message});this._ws.send(JSON.stringify({records:t}))}destroy(){this._ws&&(this._ws.close(1e3),this._ws=null,this.destroyed=!0)}}var V=s(832),K=s.n(V);const Y=class{static CHARSET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";static BITS_PER_BYTE=8;static BITS_PER_BASE64_CHAR=6;static decode(e){let t=0,s=0,i="";for(const n of e){if("="===n)break;const e=this.CHARSET.indexOf(n);for(t=t<<this.BITS_PER_BASE64_CHAR|e,s+=this.BITS_PER_BASE64_CHAR;s>=this.BITS_PER_BYTE;){s-=this.BITS_PER_BYTE;i+=(t>>s&(1<<this.BITS_PER_BYTE)-1).toString(16).padStart(2,"0").toUpperCase()}}let n="";for(let e=0;e<i.length;e++)n+=i[e],e%2==1&&e!==i.length-1&&(n+=":");return n}},X="typ host",Z="generation 0",ee="network-cost",te="rport",se="0.0.0.0",ie={V:"v=",O:"o=",S:"s=",C:"c=",A:"a=",M:"m=",T:"t="},ne={U:"ice-ufrag:",P:"ice-pwd:",F:"fingerprint:",C:"candidate:",S:"sctp-port:",M:"max-message-size:"},re={1:"sha-1",2:"sha-224",3:"sha-256",4:"sha-384",5:"sha-512",6:"md5",7:"md2",8:"token"},oe={P:`${X} ${Z} ${ee} 999`,W:`${te} 0 ${Z} ${ee} 999`,H:X,S:"typ srflx",R:te,A:"raddr",V:se,F:"ufrag",G:`${te} 0 ${Z}`,N:ee,E:"network-id",C:"tcptype active",Q:`${Z}`,U:"udp",T:"tcp"},ae={P:"application",U:"UDP/DTLS/SCTP",S:"DTLS/SCTP",D:"webrtc-datachannel"},he={4:"IP4",6:"IP6"},ce={0:se},le=e=>(e.startsWith("C")&&(e="candidate:"+e.slice(1)),e.split(" ").map((e=>(e in oe&&(e=oe[e]),e))).join(" "));function de(e,t){let s=e.split("~"),i=[];s=s.map((e=>{let t=e.slice(0,1),s=e.slice(1);if(t in ie&&(t=ie[t]),"a="===t){let e=s.slice(0,1);const t=s.slice(1);e in ne&&(e=ne[e],s=e+t)}return t+s})),i.push("v=0"),i.push("s=-"),i.push("t=0 0"),i.push("a=msid-semantic: WMS");let n=0;s.forEach((e=>{if(e.startsWith("o=")){let t=e.slice(2).split(" "),s=[];s.push("-");const n=t.shift();if(n&&s.push(n),0===t.length)s.push("2 IN IP4 127.0.0.1");else{const e=t.shift();if(e&&s.push(e),0===t.length)s.push("IN IP4 127.0.0.1");else{s.push("IN");const e=t.shift();e&&s.push(e);const i=t.shift();i&&s.push(i)}}i.splice(1,0,`o=${s.join(" ")}`)}else{if(e.startsWith("m="))return e=function(e){return e.replace(ue,(e=>ae[e]))}(e),i.push(e),i.push("a=setup:"+(t?"actpass":"active")),i.push(`a=mid:${n}`),void n++;if(e.startsWith("a=candidate:"))return e=le(e),void i.push(e);if(e.startsWith("a=fingerprint:")){let[t,s]=e.slice(14).split(" ");return t in re&&(t=re[t]),s=Y.decode(s),void i.push(`a=fingerprint:${t} ${s}`)}if(e.startsWith("c=")){let[t,s]=e.slice(2).split(" ");return t in he&&(t=he[t]),s in ce&&(s=ce[s]),void i.push(`c=IN ${t} ${s}`)}"I"!==e?"Z"!==e?"B"!==e?i.push(e):i.push("a=sendrecv"):i.push("a=ice-options:ice2,trickle"):i.push("a=ice-options:trickle")}}));const r=i.length-1;return i.splice(r,0,`a=group:BUNDLE ${Array.from(Array(n).keys()).join(" ")}`),i.join("\r\n")}const ue=new RegExp(Object.keys(ae).join("|"),"g");class ge extends(a()){constructor(e,t,s,i){super(),this.engine=e,this.logger=e.logger,this.config=i,this.connected=!1,this.scheduler=s,this.sequential=this.scheduler.sequential,this.DCMap=new Map,this.failedDCMap=new Map,this.notFoundDCSet=new Set;const n=U().isMobile();this.peerPool=new H(e,i,15),this.signalerWs=null,this.fetcher=t,this.peers=[],this.requestPeersQueue=[],this.minConns=5,this.stuns=[],this.requestMorePeers=N(this._requestMorePeers,this,y(35,45)),this.maxConns=n?15:22,this.maxConnsActive=n?10:13,this.peersIncrement=0,this.gotPeersFromTracker=!1,this.requestPeersWaitCount=0,this.gotSignalFails={main:0,backup:0,limit:5},this.fuseRate=-1,this.overloaded=!1}get totalConns(){return this.scheduler.peersNum+1}resumeP2P(){if(!this.fetcher)return;const{engine:e,config:t,fetcher:s}=this,{btAnnounce:i,btAnnouncePreflight:n}=s,{wsSignalerAddr:r,wifiOnly:o,geoIpPreflight:a}=t;(a?n:i).call(s).then((t=>{const{scheduler:i}=this;if(!i)return;e.peerId=this.peerId=t.id,this.minConns=t.min_conns,i.minConns=this.minConns;const n=t.peers;i.notifyPeersLoaded(n.length),n.length>this.gotSignalFails.limit&&(this.gotSignalFails.limit=n.length),e.netType=s.announceInfo.netType,(t.wifi_only||o)&&e.isMobileNet&&(i.downloadOnly=!0,this.logger.info("downloadOnly mode"));const a=r.main;let h=r.backup;function c(e,t){var s=l();return(c=function(e,t){return s[e-=0]})(e,t)}function l(){var e=["IHmzPt4745802".split("").reverse().join(""),"fqbpvJ65672".split("").reverse().join(""),"peerId","evitcAsnnoCxam".split("").reverse().join(""),"0r^EeI@*KS".split("").reverse().join(""),"yGChQi82100203".split("").reverse().join(""),"dIlennahc".split("").reverse().join(""),"qrZmAF0973735".split("").reverse().join(""),"qNTzkD6562665".split("").reverse().join(""),"timestamp","HaovMZ5303011".split("").reverse().join(""),"blnwIB1433257".split("").reverse().join(""),"39zAjEpC","substring"];return(l=function(){return e})()}var d,u;t.signal&&!t.signal2&&(h=void 0),this.signalerWs=this._initSignalerWs(t.signal||a,t.signal2||h,t.token,t.token2),0===n.length?this.requestMorePeers():this.peers=this._filterPeers(n),e.emitEvent("peerId",this.peerId),t.stun&&t.stun.length>0&&(this.stuns=t.stun),t.debug&&(this.logger.enableDebug(),t.log_url&&(this.logUploader=new Q(t.log_url,this.fetcher.key||location.hostname,this.peerId,"1.2.0"),this.logger.setUploader(this.logUploader))),e.onTrackerResume&&e.onTrackerResume(t),t.fuse_rate&&(this.fuseRate=t.fuse_rate),t.overload&&(this.overloaded=!0,this.logger.warn("server overloaded, degrade signaling")),this.logger.info(`announce request response ${JSON.stringify(t,null,2)}`),function(e,t){function s(e,t,s,i,n){return c(t- -94,n)}var i=e();function n(e,t,s,i,n){return c(t-586,s)}function r(e,t,s,i,n){return c(i-742,n)}for(;;)try{if(595581===-parseInt(s(0,-83,0,0,-88))/1+-parseInt(n(0,587,588))/2+parseInt(n(0,599,592))/3*(-parseInt(n(0,588,591))/4)+parseInt(s(0,-86,0,0,-83))/5+-parseInt(r(0,0,0,751,751))/6+-parseInt(r(0,0,0,754,760))/7+parseInt(c(403-397,399))/8)break;i.push(i.shift())}catch(e){i.push(i.shift())}}(l),t.v!==K()(s.channelId+this.peerId+s.timestamp+(d=701,u=702,c(d-696,u)),"1.2.0").substring(0,8)&&(this.maxConnsActive=1)})).catch((t=>{if(this.scheduler&&("TRACKER_EXPT"===t.code&&e.emitEvent(k.EXCEPTION,t),this.scheduler.notifyPeersLoaded(0),t.retry)){const e=y(15e3,4e4);this.logger.warn(`announce retry after ${e}ms`),this.announceTimer=setTimeout((()=>{this.resumeP2P()}),e)}}))}stopP2P(){this.fetcher.postStatsWithBeacon(),this.fetcher.destroy(),this.fetcher=null,this.requestMorePeers(!0),this.scheduler.destroy(),this.scheduler=null,this.signalerWs&&(this.signalerWs.destroy(),this.signalerWs=null),this.peers=[];for(let e of this.DCMap.values())e.destroy(!0);this.DCMap.clear(),this.peerPool.destroy(),this.peerPool=null,this.failedDCMap.clear(),this.notFoundDCSet.clear(),this.logUploader&&(this.logUploader.destroy(),this.logUploader=null),this.logger.warn("tracker stop p2p")}destroy(){this.stopP2P(),this.removeAllListeners(),clearTimeout(this.announceTimer),clearTimeout(this.requestPeersTimer);const{config:e}=this;e.getStats=e.getPeerId=e.getPeersInfo=null,this.logger.warn("destroy tracker")}isPeerConnectedOrFailed(e){return!e||(this.DCMap.has(e)||this.failedDCMap.has(e)||e===this.peerId)}_filterPeers(e){const t=[];return e.filter((e=>!this.isPeerConnectedOrFailed(e.id))).forEach((e=>{t.push({id:e.id,intermediator:e.intermediator})})),t}_tryConnectToAllPeers(){const{logger:e}=this;if(0!==this.peers.length)for(this._checkDCMap(),e.info(`try connect to ${this.peers.length} peers, map size ${this.DCMap.size} limit ${this.maxConnsActive} peersNum ${this.scheduler.peersNum}`);this.peers.length>0&&!(this.DCMap.size>=this.maxConnsActive);){let t=this.peers.shift();if(this.isPeerConnectedOrFailed(t.id))continue;const s=t.intermediator;this.signalerWs.connected||s&&this.DCMap.has(s)?(e.debug(`create DataChannel ${t.id} intermediator ${s}`),this._createDatachannel(t.id,!0,s)):e.info(`skip peer ${t.id} without intermediator`)}else e.info("no peers after filter")}_handleSendSignal(e,t){const s=e.remotePeerId;if(e.intermediator){const i=this.DCMap.get(e.intermediator);if(i){let n=!0;for(let e of t)i.sendMsgSignal(s,this.peerId,e)||(n=!1);if(n)return;this.logger.warn(`intermediator ${e.intermediator} relay failed`)}}e.intermediator=void 0,this.signalerWs.sendSignalBatch(s,t,e.signalName)}_setupDC(e){e.on(k.DC_SIGNAL,(t=>{this._handleSendSignal(e,[t])})).on(k.DC_SIGNAL_BATCH,(t=>{this._handleSendSignal(e,t)})).on(k.DC_PEER_SIGNAL,(t=>{const s=t.to_peer_id||t.to,i=t.from_peer_id||t.from,n=t.action;if(s&&i&&n)if(s!==this.peerId){this.logger.info(`relay signal for ${i}`);const r=this.DCMap.get(s);if(r){if("signal"!==n)return void r.sendMsgSignalReject(s,i,t.reason,t.fatal);if(r.sendMsgSignal(s,i,t.data))return}e.sendMsgSignal(i,s)}else"signal"===n?this._handleSignalMsg(i,t,e.remotePeerId):this._handSignalRejected(i,t)})).on(k.DC_GET_PEERS,(()=>{const t=S(),s=this.scheduler.getPeers().filter((e=>e.peersConnected<(e.mobileWeb?15:22)&&!e.super));if(s&&s.length>0){const i=[];s.forEach((s=>{if(s.remotePeerId===e.remotePeerId||s.remotePeerId===this.peerId)return;if(!this.config.live&&(s.currentPos-e.currentPos>600||s.currentPos<e.currentPos))return;t-s.timeJoin>50&&i.push({id:s.remotePeerId,...s.region})})),this.logger.info(`send ${i.length} peers to ${e.remotePeerId}`),e.sendPeers(i)}})).on(k.DC_PEERS,(t=>{const s=t.peers;this.logger.info(`receive ${s.length} peers from ${e.remotePeerId}`),s&&s.length>0&&(s.forEach((t=>{t.intermediator=e.remotePeerId,t.region||(t.region={})})),this.requestPeersQueue.push(...s)),this.requestPeersWaitCount--,this.requestPeersWaitCount<=0&&this._handleRequestedPeers()})).once(k.DC_ERROR,((t,s)=>{this.logger.warn(`datachannel ${e.channelId} failed fatal ${t} ${s}`),this.scheduler&&(this.scheduler.deletePeer(e),this._destroyAndDeletePeer(e.remotePeerId,t),this.fetcher&&(e.connected||t&&this.fetcher.increFailConns(),t&&this.failedDCMap.set(e.remotePeerId,`DC_FAILED ${s}`),this._doSignalFusing(this.scheduler.peersNum),this._doPeersRequest()))})).once(k.DC_TIMEOUT,(({gotSignal:t,sentSignal:s,data:i})=>{const{logger:n,signalerWs:r,gotSignalFails:o}=this,{remotePeerId:a,useBackupSignal:h,isInitiator:c}=e,l=h?"backup":"main";if(t?o[l]=0:(o[l]++,o[l]>=o.limit&&(o[l]=0,n.warn("gotSignalFails many, forcePolling"),r.forcePolling(l))),s&&t&&c&&(this.failedDCMap.set(a,"DC_TIMEOUT"),this.fetcher&&this.fetcher.increFailConns()),!t&&c&&!h&&this._tryBackupSignal(e,a,i))return e._startTimer(),void n.warn(`${a} conn timeout, try backup signal`);this._destroyAndDeletePeer(a,!1),this._doPeersRequest()})).once(k.DC_CLOSE,(t=>{this.logger.info(`datachannel ${e.channelId} closed fatal ${t}`),this.scheduler&&(this.scheduler.deletePeer(e),this._doSignalFusing(this.scheduler.peersNum)),this._destroyAndDeletePeer(e.remotePeerId,t),t&&this.failedDCMap.set(e.remotePeerId,"DC_CLOSE"),this._doPeersRequest()})).once(k.DC_OPEN,(()=>{e.isInitiator&&this.scheduler.handshakePeer(e)})).once(k.DC_METADATA,(t=>{const{scheduler:s}=this;e.isInitiator||s.handshakePeer(e),s.handleMetaData(e,t);const i=this.DCMap.size>=this.maxConnsActive;this.requestMorePeers(i),e.intermediator&&this.peersIncrement++,this._doSignalFusing(s.peersNum)}))}_doPeersRequest(){const e=this.scheduler.peersNum;!this.signalerWs.connected||this.overloaded&&e>this.minConns?this._requestPeersFromPeers(e):this.requestMorePeers(),this._tryConnectToAllPeers()}_doSignalFusing(e){if(this.fuseRate<=0)return;const t=this.signalerWs.connected;t&&e>=this.fuseRate?(this.logger.warn("reach fuseRate, report stats close signaler"),this.totalConns-1>0&&this.fetcher.postStats(),this.signalerWs.close()):!t&&e<=this.minConns&&this.signalerWs.normalClosed&&(this.logger.warn(`low conns ${e}, reconnect signaler`),this.signalerWs.reconnect())}_initSignalerWs(e,t,s,i){const n=(e,t)=>{let s=`${e}?id=${this.peerId}&p=web&v=1.2.0`;return this.config.signalCompact&&(s=`${s}&c=1`),t&&(s=`${s}&token=${t}`),s};let r,o=n(e,s);if(t&&t!==e){let e=n(t,i);r=new D(this.logger,this.config,o,e)}else r=new R(this.logger,this.config,o);return r.onopen=()=>{this.connected=!0,this.engine.emitEvent("serverConnected",!0),this._tryConnectToAllPeers()},r.onmessage=(e,t)=>{let s=e.action;const i=e.from_peer_id||e.from;if(i)switch(s){case"signal":this._handleSignalMsg(i,e,null,t);break;case"reject":this._handSignalRejected(i,e);break;default:this.logger.warn(`Signal websocket unknown action ${s}`)}else this.logger.warn("fromPeerId is missed")},r.onclose=()=>{this.connected=!1,this.engine.emitEvent("serverConnected",!1)},r.onerror=e=>{e.message&&this.logger.warn(`signal err: ${e.message}`),e.message&&this.engine.emitEvent(k.EXCEPTION,L(e,"SIGNAL_EXPT"))},r}_handSignalRejected(e,t){const s=`signaling ${e} rejected`;this.logger.warn(`${s}, reason ${t.reason}`);const i=this.DCMap.get(e);i&&!i.connected&&(i.destroy(t.fatal),this.DCMap.delete(e)),this.requestMorePeers(),t.fatal&&this.failedDCMap.set(e,s),this._tryConnectToAllPeers()}_tryBackupSignal(e,t,s,i="main"){return!(!(this.signalerWs.backupConnected&&e&&s.length>0&&"main"===i)||e.useBackupSignal)&&(e.useBackupSignal=!0,e.signalName="backup",e.intermediator=void 0,this.signalerWs.sendSignalBatch(t,s,"backup"),!0)}_handleSignalMsg(e,t,s,i){if(!this.scheduler)return;const{logger:n}=this;if(t.data){if(this.failedDCMap.has(e))return void this._sendSignalReject(e,`${e} ${this.failedDCMap.get(e)||"unknown"}`,s,i,!0);this._handleSignal(e,t.data,s,i)}else{const t=this.DCMap.get(e);if(!t)return;if(this._tryBackupSignal(t,e,t.signalMsgs,i))return void this.logger.warn(`${e} not found from main, try backup signal`);if(t.useBackupSignal)return;this._destroyAndDeletePeer(e),n.info(`signaling ${e} not found`);const{scheduler:r}=this;r.waitForPeer&&(r.waitingPeers--,0===r.waitingPeers&&r.notifyPeersLoaded(0)),this.requestMorePeers(),this._tryConnectToAllPeers(),s||this.notFoundDCSet.add(e)}}_handleSignal(e,t,s,i){let n=t;"string"==typeof n?n=(e=>{if("C"===e[0])return{type:"candidate",candidate:{candidate:le(e),sdpMLineIndex:0,sdpMid:"0"}};const t=e.slice(1),s="O"===e[0];return{type:s?"offer":"answer",sdp:de(t,s)}})(n):t=void 0;const r=n.type,{logger:o}=this;let a=this.DCMap.get(e);if(a){if(a.connected)return void o.info("datachannel had connected, signal ignored");if("offer"===r&&a.isInitiator){if(!(this.peerId>e))return void o.warn(`${e} signal type wrong ${r}, ignored`);o.warn(`${e} signal type wrong ${r}, convert to non initiator`),this._destroyAndDeletePeer(e,!1),a=this._createDatachannel(e,!1,s)}}else{if("answer"===r){const t=`${e} type wrong ${r}`;return o.warn(t),this._sendSignalReject(e,t,s,i),void this._destroyAndDeletePeer(e,!1)}if(o.debug(`receive node ${e} connection request`),this.DCMap.size>=this.maxConns){const t=`reach limit ${this.maxConns}`;return o.warn(t),void this._sendSignalReject(e,t,s,i)}a=this._createDatachannel(e,!1,s)}a&&(i&&(a.signalName=i),a.receiveSignal(n,t))}_createDatachannel(e,t,s){if(!this.fetcher)return;let i;if(t&&this.peerPool.available)i=this.peerPool.getPeer(),this.logger.info(`get peer from pool, signal size ${i.signalMsgs.length}`),i.intermediator=s,i.assignPeerId(this.peerId,e);else{let n=this.config.trickleICE;this.overloaded&&(n=!1),i=new G(this.engine,this.peerId,e,t,this.config,{stuns:this.stuns,intermediator:s,trickle:!s&&n})}return this.DCMap.set(e,i),this._setupDC(i),i}_sendSignalReject(e,t,s,i,n){if(s){const i=this.DCMap.get(s);if(i&&i.sendMsgSignalReject(e,this.peerId,t,n))return}this.signalerWs.sendReject(e,t,n,i)}_requestMorePeers(e){if(!this.fetcher)return;const{logger:t}=this,s=this.scheduler.peersNum;s>=this.maxConnsActive||(t.info(`requestMorePeers after delay ${e}, peersIncrement ${this.peersIncrement}`),s<3||s<this.minConns&&this.peersIncrement<=3&&!this.gotPeersFromTracker?this._requestPeersFromServer(s):this._requestPeersFromPeers(s)||this._requestPeersFromServer(s),this.peersIncrement=0)}_requestPeersFromServer(e){const{logger:t}=this;this.failedDCMap.size>50&&(this.failedDCMap=new Map([...this.failedDCMap].slice(-50))),this.notFoundDCSet.size>20&&(this.notFoundDCSet=new Set([...this.notFoundDCSet].slice(-20))),this.fetcher.btGetPeers([...this.DCMap.keys(),...this.failedDCMap.keys(),...this.notFoundDCSet.keys()],0===e).then((e=>{e&&e.peers&&(t.info(`requestMorePeers resp ${JSON.stringify(e,null,2)}`),this.peers=this._filterPeers(e.peers),this._tryConnectToAllPeers())})).catch((e=>{t.error(`requestMorePeers error ${e}`)})),this.gotPeersFromTracker=!0}_requestPeersFromPeers(e){return!!this.requestPeersTimer||(e>=this.maxConnsActive||(this.requestPeersWaitCount=this.scheduler.requestPeers(),0!==this.requestPeersWaitCount&&(this.gotPeersFromTracker=!1,this.requestPeersTimer=setTimeout((()=>{this.logger.warn("requestPeersTimer timeout"),this._handleRequestedPeers()}),1e4),!0)))}_handleRequestedPeers(){if(clearTimeout(this.requestPeersTimer),this.requestPeersTimer=void 0,this.fetcher){if(this.requestPeersQueue.length>0){const e=function(e,t){const s=[],i=new Set;for(let t of e)i.has(t.id)||(i.add(t.id),s.push(t));const{asn:n,country:r}=t;if(!n||!r||s.length<2)return s;const o=s.filter((e=>!e.asn&&!e.country)),a=s.filter((e=>e.country===r&&e.asn!==n)),h=s.filter((e=>e.asn===n&&e.country===r)),c=s.filter((e=>!o.includes(e)&&!h.includes(e)&&!a.includes(e)));return h.concat(a).concat(o).concat(c)}(this.requestPeersQueue,this.fetcher.announceInfo);this.peers=this._filterPeers(e),this.requestPeersQueue=[]}this._tryConnectToAllPeers()}}_destroyAndDeletePeer(e,t=!0){const s=this.DCMap.get(e);return!!s&&(s.destroy(t),this.DCMap.delete(e),!0)}_checkDCMap(){const e=S();for(let t of this.DCMap.values()){const s=e-t.timeJoin;e-t.timeJoin>30&&!t.connected&&(this.logger.warn(`delete ${t.remotePeerId} not connected for ${s} in DCMap`),this._destroyAndDeletePeer(t.remotePeerId,!1))}}}const fe=ge,pe=e=>{const t=localStorage.getItem(e);try{const e=JSON.parse(t);return e.value?e.value:e}catch(e){return t}},me=(e,t,s)=>{((e,t)=>{"object"==typeof t&&(t=JSON.stringify(t)),localStorage.setItem(e,t)})(e,{value:t,duration:s,startTime:Date.now()})};class _e{constructor(){this.p2p=0,this.share=0,this.http=0}recordP2p(e){this.p2p+=e}recordShare(e){this.share+=e}recordHttp(e){this.http+=e}resetTraffic(){this.p2p=0,this.share=0,this.http=0}get healthRatio(){if(0===this.http)return 1e3;let e=Math.round((this.p2p+this.share)/this.http*100);return e<=0&&(e=1),e}}const Se="SW_GEOIP_KEY",ye=2592e5,ve=432e5,Ce="TRACKER_EXPT",we="IPAPI_ERROR",Pe="ZXU",be="uY2R",Ee="LmNv",Ie="uYnll",Te="bQ==",Ae="Z3o",Re="aGsuc3d",De="hcm1j",Me="bG91ZC",Le="5uZXQ=",ke=Symbol("httpDownloaded"),Ne=Symbol("p2pDownloaded"),$e=Symbol("p2pUploaded");class Oe extends(a()){constructor(e,s,i,n,r){let o;super(),this.config=e.config;let a=this.config.announceLocation;switch(this.config.trackerZone&&(a=this.config.trackerZone),a){case"hk":o=Re+De+Me+Le;break;case"us":o="dXMuaGR0dmNsb3VkLmNvbQ==";break;case"cn":o=Ae+be+Ie+Ee+Te;break;default:o=Pe+be+Ie+Ee+Te}this.engine=e,this.key=s||void 0,this.baseUrl=n||`https://${self.atob(o)}/v1`,this.channelId=self.btoa(i),this.timestamp=S(),this.health=new _e;const h=t().parseURL(this.baseUrl).netLoc;this.announce=h.replace(/\/\//,""),function(e,t){function s(e,t,s,i,n){return c(s-219,n)}var i,n,r=e();function o(e,t,s,i,n){return c(n- -994,e)}function a(e,t,s,i,n){return c(i-233,t)}function h(e,t,s,i,n){return c(n-305,s)}for(;;)try{if(156690===-parseInt(a(0,246,0,247))/1*(-parseInt(a(0,243,0,248))/2)+-parseInt(a(0,238,0,245))/3+parseInt(o(-1e3,0,0,0,-989))/4*(-parseInt(s(0,0,225,0,216))/5)+-parseInt((i=-180,n=-173,c(n- -181,i)))/6*(parseInt(h(0,0,324,0,324))/7)+-parseInt(o(-991,0,0,0,-990))/8*(parseInt(h(0,0,313,0,307))/9)+-parseInt(h(0,0,310,0,305))/10+-parseInt(o(-968,0,0,0,-974))/11*(-parseInt(s(0,0,226,0,216))/12))break;r.push(r.shift())}catch(e){r.push(r.shift())}}(d);function c(e,t){var s=d();return(c=function(e,t){return s[e-=0]})(e,t)}const l=function(e,t,s,i,n,r){let o=location.hostname;o===c(-922- -923,-915)&&r&&(o=r+"."+o);return 13,K()(o+"1.2.0"+s+i+n,e).substr(0,8)}(this.timestamp,0,this.announce,this.channelId,r.type,this.key);function d(){var e=["13055AgbnUs","2739cfXSxI","CxYEuy093515".split("").reverse().join(""),"localhost","OCXDId9".split("").reverse().join(""),"yek".split("").reverse().join(""),"QyapiZ8635101".split("").reverse().join(""),"scRrUF02".split("").reverse().join(""),"bNcslL58187".split("").reverse().join(""),"QEbZrW65772".split("").reverse().join(""),"12gYmKGR","emantsoh".split("").reverse().join(""),"dIlennahc".split("").reverse().join(""),"pmatsemit".split("").reverse().join(""),"676614MZdLCs","type","hpNRbU1".split("").reverse().join(""),"133332xoUKrS","announce","lmia","substr"];return(d=function(){return e})()}c(895-878,886),this.native=!(!r.bundle||!window.electron&&!navigator.userAgent.toLowerCase().includes("electron")),this.announceInfo={...r,channel:this.channelId,ts:this.timestamp,version:"1.2.0",v:l,announce:this.announce,k:We(this.key)},this.announceURL=`${this.baseUrl}/channel`,this.reportFails=0,this.statsRequesting=!1,this.forbidden=!1,this.failConns=0,this.totalHTTPDownloaded=0,this.totalP2PDownloaded=0,this.totalP2PUploaded=0,this[ke]=0,this[Ne]=0,this[$e]=0,this.speed=0,this.offline=!1,this.errsBufStalled=0,this.mediaRequests=0,this.errsInternalExpt=0}geoipRequest(){const{logger:e}=this.engine;return new Promise(((t,s)=>{if((e=>{const t=localStorage.getItem(e);try{const e=JSON.parse(t);return!(!e.duration||!e.startTime)&&Date.now()-e.startTime<e.duration}catch(e){return!1}})(Se)){const s=pe(Se);e.info("found local geo data"),t(s)}else fetch(self.atob("aHR0cHM6Ly9wcm8uaXAtYXBpLmNvbS9qc29uP2ZpZWxkcz0yMTgxODI2JmtleT1YT3BpYW5zUmdZeEdUaG8=")).then((e=>e.json())).then((e=>{if("success"!==e.status){const t=new Error(`preflight status ${e.status}`);throw L(t,we)}{const s=e.mobile?ve:ye;me(Se,e,s),t(e)}})).catch((e=>{s(e)}))}))}btAnnouncePreflight(){const{logger:e}=this.engine;return this.announceInfo.asn?this.btAnnounce():(e.info("preflight ip-api"),Promise.race([this.geoipRequest(),new Promise(((e,t)=>{setTimeout((()=>{t(L(new Error("request timeout"),we))}),600)}))]).then((e=>(this._parseGeoResponse(e),this.btAnnounce()))).catch((t=>{if(t.code!==Ce){const t=pe(Se);return t&&(e.info("use expired ipData"),this._parseGeoResponse(t)),this.btAnnounce()}throw t})))}_parseGeoResponse(e){const{lat:t,lon:s,isp:i,as:n,mobile:r,countryCode:o,continentCode:a}=e;r&&(this.announceInfo.netType="cellular");const h=n.split(" ")[0].substr(2);this.announceInfo={...this.announceInfo,lat:t,lon:s,isp:i,asn:h,country:o}}btAnnounce(){const{logger:e}=this.engine;return new Promise(((t,s)=>{fetch(this.announceURL,{headers:this._requestHeader,method:"POST",body:JSON.stringify(this.announceInfo)}).then((e=>{if(!e.ok){const t=e.status>=500&&e.status<600;throw L(new Error(`server response code is ${e.status}`),Ce,{retry:t})}return e.json()})).then((e=>{if(!this.engine)throw L(new Error("runtime error"),Ce,{retry:!1});const s=e.data;if(s.f&&(this.forbidden=!0),-1===e.ret){const{code:t,msg:s}=e.data;throw L(new Error(s),Ce,{retry:t>=5e3})}if(s.info&&console.info(`${s.info}`),s.warn&&console.warn(`${s.warn}`),s.min_conns||(s.min_conns=8),(!s.rejected||s.rejected&&s.share_only)&&s.id&&s.report_interval&&s.peers){if(this.peerId=this.id=s.id,s.report_interval<20&&(s.report_interval=20),this.btStats(s.report_interval),this.getPeersURL=`${this.baseUrl}/channel/${this.channelId}/node/${this.peerId}/peers`,this.statsURL=`${this.baseUrl}/channel/${this.channelId}/node/${this.peerId}/stats`,!this.announceInfo.asn&&s.asn){const{country:e,asn:t,mobile:i,isp:n,lat:r,lon:o}=s;this.announceInfo={...this.announceInfo,country:e,asn:t},me(Se,{countryCode:e,as:`AS${t}`,mobile:i,isp:n,lat:r,lon:o,status:"success"},i?ve:ye)}t(s)}else this.engine&&(this.engine.p2pEnabled=!1)})).catch((t=>{e.error(`btAnnounce error ${t}`);const i=t.code||Ce,n=!t.code||t.retry;s(L(t,i,{retry:n}))}))}))}btStats(e=10){this.heartbeater=setInterval((()=>{this.postStats()}),1e3*e)}postStatsWithBeacon(){if(this.offline)return;this.offline=!0;let e={off:!0};this.statsRequesting||(e={...e,...this._makeStatsBody()}),this.statsURL&&navigator.sendBeacon&&navigator.sendBeacon(this.statsURL,JSON.stringify(e))}postStats(){const{logger:e}=this.engine;this.statsRequesting=!0,fetch(this.statsURL,{method:"POST",body:JSON.stringify(this._makeStatsBody())}).then((e=>(this.statsRequesting=!1,this.reportFails=0,e.text()))).then((t=>{let s;if(s=t?JSON.parse(t):{ret:0,data:{}},-1===s.ret)clearInterval(this.heartbeater),e.error(`${s.data.msg} code ${s.data.code}`),this.engine.emit(k.RESTART_P2P);else{const{http:e=0,p2p:t=0,share:s=0,failConns:i=0,rebuffers:n=0,requests:r=0,errsInternalExpt:o=0}=this.lastStats||{};this[ke]>=e&&(this[ke]-=e),this[Ne]>=t&&(this[Ne]-=t),this[$e]>=s&&(this[$e]-=s),this.failConns>=i&&(this.failConns-=i),this.errsBufStalled>=n&&(this.errsBufStalled-=n),this.mediaRequests>=r&&(this.mediaRequests-=r),this.errsInternalExpt>=o&&(this.errsInternalExpt-=o),this.exptMsg&&(this.exptMsg=void 0)}})).catch((t=>{e.error(`btStats error ${t}`),this.statsRequesting=!1,this.reportFails++,this.reportFails>=3&&clearInterval(this.heartbeater)}))}btGetPeers(e,t=!1){const{logger:s}=this.engine,{asn:i,country:n}=this.announceInfo;let r={exclusions:e,asn:i,country:n,ratio:this.health.healthRatio,urgent:t||void 0},o={};return this.engine.getExtraForPeersRequest&&(o=this.engine.getExtraForPeersRequest()),r=Object.assign({},r,o),new Promise(((e,t)=>{this.reportFails>=3?t(new Error("reportFails >= 3")):fetch(this.getPeersURL,{headers:this._requestHeader,method:"POST",body:JSON.stringify(r)}).then((e=>e.json())).then((s=>{-1===s.ret?t(s.data.msg):e(s.data)})).catch((e=>{s.error(`btGetPeers error ${e}`),t(e)})).finally((()=>{this.health.resetTraffic()}))}))}increFailConns(){this.failConns++}increRebuffers(){this.engine.emitEvent("bufferStalled"),this.errsBufStalled++}increMediaRequests(){this.mediaRequests++,this.engine.emit(k.MEDIA_REBUFFER,this.errsBufStalled>=2)}reportFlow(e){const t=Math.round(e/1024);this.engine.emitEvent("httpDownloaded",t),this[ke]+=t,this.totalHTTPDownloaded+=t,this.health.recordHttp(t),this._emitStats()}reportDCTraffic(e,t){const s=Math.round(e/1024);this[Ne]+=s,this.totalP2PDownloaded+=s,this.health.recordP2p(s),this.speed=Math.round(t),this.engine.emitEvent("p2pDownloaded",s,this.speed),this._emitStats()}reportUploaded(e=0){const t=Math.round(e/1024);this.engine.emitEvent("p2pUploaded",t),this.totalP2PUploaded+=t,this.health.recordShare(t),this[$e]+=t,this._emitStats()}destroy(){const{logger:e}=this.engine;e.warn("destroy fetcher"),this.removeAllListeners(),clearInterval(this.heartbeater)}_emitStats(){const{totalHTTPDownloaded:e,totalP2PDownloaded:t,totalP2PUploaded:s}=this;this.engine.emit("stats",{totalHTTPDownloaded:e,totalP2PDownloaded:t,totalP2PUploaded:s,p2pDownloadSpeed:this.speed});const{getStats:i}=this.config;I(i)&&i(t,s,e,this.speed)}_makeStatsBody(){const{asn:e,country:t}=this.announceInfo;let s={totalConns:this.engine.tracker.totalConns,failConns:this.failConns,rebuffers:this.errsBufStalled||void 0,requests:this.mediaRequests||void 0,errsInternalExpt:this.errsInternalExpt,http:Math.round(this[ke])||0,p2p:Math.round(this[Ne])||0,share:Math.round(this[$e])||0,asn:e,country:t},i={};this.engine.getExtraForStats&&(i=this.engine.getExtraForStats()),s=Object.assign({},s,i),this.lastStats=JSON.parse(JSON.stringify(s)),Object.keys(s).forEach((e=>{0===s[e]&&delete s[e]}));const{logger:n}=this.engine;return n.isDebugLevel&&n.info(`report ${JSON.stringify(s)}`),this.exptMsg&&(s.exptMsg="1.2.0 "+this.exptMsg),s}get _requestHeader(){let e={};return this.native&&(e={...e,"X-SW-Key":We(this.key),"User-Agent":"electron","X-SW-ID":this.announceInfo.bundle}),e}}const Be=Oe;function qe(e,t){const s=xe();return(qe=function(e,t){return s[e-=0]})(e,t)}function xe(){const e=["CsLPpZ8932212".split("").reverse().join(""),"htgnel".split("").reverse().join(""),"UZpUzY5895021".split("").reverse().join(""),"yJZuxA9452121".split("").reverse().join(""),"tAedoCrahc".split("").reverse().join(""),"btoa","q#<K@C".split("").reverse().join(""),"1164HyWkyu","4154136SJSwNe","IITNvu6344771".split("").reverse().join(""),"edoCrahCmorf".split("").reverse().join(""),"554Biqadw","oShtCc7412072".split("").reverse().join("")];return(xe=function(){return e})()}function We(e){if(!e)return;const t=qe(-822- -830,-826);let s="".split("").reverse().join("");const i=t.length;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n)^t.charCodeAt(n%i);s+=String.fromCharCode(r)}return self.btoa(s)}!function(e,t){const s=e();function i(e,t,s,i,n){return qe(e-92,n)}function n(e,t,s,i,n){return qe(n-930,s)}for(;;)try{if(377468===parseInt(n(0,0,944,0,939))/1*(parseInt(n(0,0,936,0,930))/2)+parseInt(n(0,0,929,0,935))/3+parseInt(n(0,0,939,0,941))/4+-parseInt((r=-995,o=-995,qe(r- -999,o)))/5+parseInt(i(94,0,0,0,91))/6+-parseInt(i(93,0,0,0,92))/7+-parseInt(i(102,0,0,0,107))/8)break;s.push(s.shift())}catch(e){s.push(s.shift())}var r,o}(xe);const Fe={debug:0,info:1,warn:2,error:3,none:4};const ze=class{constructor(e){this.logLevel=e,this.onlineDebug=!1,this.logCache=[];try{console.debug=console.log}catch(e){console.debug=console.info}"debug"!==e&&"info"!==e||(this.logLevel="warn"),pe("SW_DEBUG")&&(this.logLevel="debug"),!0===e?this.logLevel="warn":!1===e?this.logLevel="none":e in Fe||(this.logLevel="error"),this.resetLogger()}enableDebug(){this.onlineDebug=!0;for(let e in Fe)this[e]=console[e];this._hookLogFunc(((e,t)=>{this.logUploader&&this.logUploader.send(e,t)}))}enableReport(e){this.reportUrl=e,this._hookLogFunc(((e,t)=>{this.reportUrl?(this.logCache.push({levelKey:e,message:`${E()}: ${t}`}),this.logCache.length>350&&this.logCache.shift()):this.reporter&&this.reporter.send(e,t)}))}report(e,t,s,i,n=5e3){this.reportUrl&&(e&&this.logCache.unshift({levelKey:"info",message:e}),this.reporter=new Q(this.reportUrl,t,s,i),this.reporter._ws.addEventListener("open",(()=>{this.reportUrl=void 0,this.reporter.sendBatch(this.logCache),setTimeout((()=>{this.reporter.destroy(),this.reporter=null}),n)}),{once:!0}))}_hookLogFunc(e){for(let t in Fe){const s=this[t];this[t]=i=>{e(t,i),s(i)}}}setUploader(e){this.logUploader=e}resetLogger(){this.onlineDebug=!1;for(let e in Fe)Fe[e]<Fe[this.logLevel]?this[e]=_:this[e]=console[e]}get isDebugLevel(){return Fe[this.logLevel]<=2||this.onlineDebug}},Ue={DPlayer:"dplayer",CBPlayer:"cbplayer",jwplayer:"jwplayer",videojs:"videojs",Clappr:"clappr",ckplayer:"ckplayer",MediaElementPlayer:"mediaelement",MediaElement:"mediaelement",TcPlayer:"tcplayer",flowplayer:"flowplayer",Chimee:"chimee",ChimeePlayer:"chimee",HlsJsPlayer:"xgplayer",fluidPlayer:"fluidplayer",OpenPlayer:"openplayer",Plyr:"plyr",Playerjs:"playerjs",Aliplayer:"aliplayer",shaka:"shakaplayer",RadiantMP:"rmp",bitmovin:"bitmovin"};const je="nllL",Ge="d3NzJ",He="==",Je="TNBLy9z",Qe="aWduY",Ve="mNvbQ",Ke="WwuY2RuY",Ye={[k.EXCEPTION]:"onException",serverConnected:"onServerConnected",peerId:"getPeerId",p2pDownloaded:"onP2pDownloaded",p2pUploaded:"onP2pUploaded",httpDownloaded:"onHttpDownloaded",bufferStalled:"onBufferStalled",peers:"getPeersInfo"};class Xe extends(a()){constructor(e={}){var t;if(super(),this.p2pEnabled=!(!1===e.p2pEnabled||"0"===(t="_p2p",new URL(location.href).searchParams.get(t))),e.tag&&e.tag.length>20)throw new Error("Tag is too long");if(e.appName&&e.appName.length>30)throw new Error("appName is too long");if(e.appId&&e.appId.length>30)throw new Error("appId is too long");if(e.token&&e.token.length>20)throw new Error("Token is too long");this.segmentLoadCount=0,this.rangeTested=!1,this.trackerTried=!1,this.playerName=function(){let e;for(let t in Ue)if(self[t]){e=Ue[t];break}return e}()}resumeTracker(){this.tracker&&!this.trackerTried&&!this.tracker.connected&&this.config.p2pEnabled&&(this.tracker.resumeP2P(),this.trackerTried=!0)}onTrackerResume(e){e.report_url&&this.logger.enableReport(e.report_url)}startRangeRequestTimer(){const{config:e,logger:t}=this,s=()=>{this.curTsUri&&v(this.curTsUri,void 0,e.xhrSetup).then((()=>{e.httpRangeSupported=!0,clearTimeout(this.rangeRequestTimer)})).catch((i=>{e.httpRangeSupported=!1,t.warn(i),this.rangeRequestTimer=setTimeout(s,6e4)})).finally((()=>{t.info(`http range is${e.httpRangeSupported?"":" not"} supported`)}))};this.rangeRequestTimer=setTimeout(s,0)}initLogger(){const{config:e}=this;e.showSlogan&&"en"==("zh-CN"===(navigator.language||navigator.userLanguage)?"cn":"en")&&console.log(`%cLet the browsers become your unlimitedly scalable CDN!\n%c${self.atob("aHR0cHM6Ly9zd2FybWNsb3VkLm5ldA==")}`,"color: dodgerblue; padding:20px 0; font-size: x-large","font-size: medium; padding-bottom:15px");const t=new ze(e.logLevel);return e.logger=this.logger=t,t}getExtraForStats(){return{}}getExtraForPeersRequest(){const e={};return e.num_want=this._getNumWant(),e}_getNumWant(){const{tracker:e}=this;if(!e.scheduler)return;const t=e.scheduler.peersNum;return t>0&&e.maxConnsActive-t>0?e.maxConnsActive-t:void 0}makeChannelId(e,t){if(!e||"string"!=typeof e){const e="token is required while using customized channelId!";throw console.error(e),new Error(e)}return I(t)?(s,i)=>`${e}-${t(s,i)}`:()=>`${e}-${t}`}makeSignalId(){let e="";const{config:s}=this,i=decodeURIComponent(self.atob(Ge+Je+Qe+Ke+je+Ve+He));s.signalConfig&&(s.wsSignalerAddr=s.signalConfig);const{wsSignalerAddr:n}=s;if(n){let r;"object"==typeof n?(n.main||(n.main=i),r=n.main):"string"==typeof n&&(r=n,s.wsSignalerAddr={main:r}),r===i&&(r=void 0),r&&!s.wsSignalerAddr.backup&&(e=t().parseURL(r).netLoc.substring(2))}else s.wsSignalerAddr={main:i,byDefault:!0};return e}get commonBrowserInfo(){const e=U().getPlatform(),t=U().getNetType()||"wifi";this.netType=t;const{main:s,backup:i,byDefault:n}=this.config.wsSignalerAddr||{};return{signal:n?void 0:s,signal2:i,device:e,netType:t,player:this.playerName}}get isMobileNet(){return"wifi"!==this.netType&&"ethernet"!==this.netType}setupWindowListeners(e){const t=["iPad","iPhone"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",s=()=>{this.fetcher&&this.fetcher.postStatsWithBeacon(),this.p2pEnabled&&this.disableP2P(),self.removeEventListener(t,s)};e?self.removeEventListener(t,s):self.addEventListener(t,s)}destroy(){clearTimeout(this.rangeRequestTimer),this.disableP2P(!0),this.removeAllListeners(),this.setupWindowListeners(!0)}enableP2P(){return this.p2pEnabled?null:(this.logger&&this.logger.info("enable P2P"),this.config.p2pEnabled=this.p2pEnabled=!0,this.browserInfo?(this._init(this.channel,this.browserInfo),this):null)}get version(){return Xe.version}static isSupported(){const e=w();return!(!e||void 0===e.RTCPeerConnection.prototype.createDataChannel)}static get TrackerZone(){return{EU:"eu",HK:"hk",USA:"us",CN:"cn"}}determineHttpLoadTime(e,t,s){this.logger&&this.logger.info(`segments in playlist: ${e.length}, targetDuration: ${t} startSN ${s}`);let i=4;return t<=2?i=1.5:t<=3?i=2:t<=4?i=2.5:t<=5?i=3:t<=6&&(i=3.5),i}emitEvent(e,...t){this.emit(e,...t);const s=Ye[e];s&&I(this.config[s])&&this.config[s](...t)}}Xe.version="1.2.0",Xe.protocolVersion=G.VERSION;const Ze=Xe,et={...k,ERROR:"error",SW_MEDIA:"SW_MEDIA",SW_CANCEL:"SW_CANCEL",SW_GET_FRAG:"SW_GET_FRAG",FRAG_LOADED:"FRAG_LOADED"};const tt=class{constructor(){this.peerMap=new Map}isEmpty(){return 0===this.peerMap.size}size(){return this.peerMap.size}clear(){this.peerMap.clear()}getPeers(){return[...this.peerMap.values()]}getPeerValues(){return this.peerMap.values()}hasPeer(e){return this.peerMap.has(e)}addPeer(e,t){this.peerMap.set(e,t)}getPeerIds(){return[...this.peerMap.keys()]}removePeer(e){this.peerMap.delete(e)}getPeersOrderByWeight(){const e=this.getAvailablePeers();return e.sort(((e,t)=>0===t.weight?1:0===e.weight?-1:t.weight-e.weight)),e}getPeer(e){return this.peerMap.get(e)}getAvailablePeers(){return this.getPeers().filter((e=>e.isAvailableUrgently))}},st=Symbol("shareOnly");class it extends(a()){constructor(e,t){super(),this.engine=e,this.config=t,this.logger=e.logger,this.bufMgr=null,this.peerManager=new tt,this.fragLoading=!1,this._setupEngine&&this._setupEngine(),this.startCheckConnsTimer(),this.dcDownloadTimeout=t.dcDownloadTimeout,this[st]=!1,this.downloadOnly=!1,this.loadedPeerNum=0,this.minConns=5}get isMobileNet(){return this.engine.isMobileNet}startCheckConnsTimer(){this.checkConnsTimer=setInterval((()=>{this.logger.info("start check conns");const e=this.getStatsForPeer();let t=this.peersNum;const s=S();this.getPeers().forEach((i=>{t>this.minConns+1&&(s-i.dataExchangeTs>120||s-i.gotStatsTs>=83)?(this.logger.warn(`close dead peer ${i.remotePeerId} level ${i.currentLevel}`),i.close(!1),t--):i.connected&&i.sendMsgStats(t,e)}))}),4e4)}get httpRangeSupported(){return this.config.httpRangeSupported}getStatsForPeer(){return{}}_handlePieceAborted(){}requestPeers(){const e=S();let t=0;for(let s of this.getPeers())s.mobileNet||s.super||(e-s.gotPeersTS<60?this.logger.warn(`${s.remotePeerId} just got peers, ignored`):(s.sendPeersRequest(),s.gotPeersTS=e,t++));return t}chokePeerRequest(e){const t={event:k.DC_CHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}unchokePeerRequest(e){const t={event:k.DC_UNCHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}stopRequestFromPeers(){for(let e of this.getPeers())e.choked=!0}resumeRequestFromPeers(){for(let e of this.getPeers())e.choked=!1}setShareOnly(){this[st]=!0}deletePeer(e){e.downloading&&this._handlePieceAborted(e.remotePeerId),this.peerManager.hasPeer(e.remotePeerId)&&this.peerManager.removePeer(e.remotePeerId),this._peersStats(this.peerManager.getPeerIds())}getPeers(){return[...this.peerManager.getPeerValues()]}addPeer(e){const{logger:t}=this;this.peerManager.addPeer(e.remotePeerId,e),this[st]&&(e.choked=!0);const s=this.peerManager.getPeerIds();this._peersStats(s);const{asn:i,country:n}=e.region||{};t.info(`add peer ${e.remotePeerId} country ${n||""} asn ${i||""}, now has ${s.length} peers`)}hasPeer(e){return this.peerManager.hasPeer(e)}get hasPeers(){return this.peersNum>0}get peersNum(){return this.peerManager.size()}get hasIdlePeers(){const{logger:e}=this,t=this.getIdlePeer().length;if(e.info(`peers: ${this.peersNum} idle peers: ${t}`),t<this.peersNum){const t=this.peerManager.getPeers(),s=t.filter((e=>e.downloading));e.warn(`downloading: ${s.length} choked: ${t.filter((e=>e.choked)).length}`);for(let t of s)e.warn(`${t.remotePeerId} loading ${t.segId} remains ${t.remainAttachments} total ${t.pieceMsg.attachments}`)}return t>0}getIdlePeer(){return this.peerManager.getAvailablePeers()}set bufferManager(e){this.bufMgr=e,e.on(k.BM_LOST,(({sn:e,segId:t,next:s,level:i})=>{this._broadcastLost(e,t,i),this.onBufferManagerLost(e,t,s,i)})).on(k.BM_SEG_ADDED,(e=>{this.onBufferManagerSegAdded(e)}))}onBufferManagerSegAdded(e){}_broadcastLost(e,t,s,i){this.config.live||this._broadcastToPeers({event:k.DC_LOST,sn:e,seg_id:t||void 0,level:s},i)}destroy(){const{logger:e}=this;this.peersNum>0&&this.peerManager.clear(),this.removeAllListeners(),clearInterval(this.checkConnsTimer),clearTimeout(this.checkTimer),e.warn("destroy BtScheduler")}notifyPeersLoaded(e){}_setupDC(e){const{logger:t}=this;e.on(k.DC_PIECE_ACK,(s=>{s.size&&(this.engine.fetcher.reportUploaded(s.size),t.info(`uploaded ${s.seg_id} size ${s.size} to ${e.remotePeerId}`))})).on(k.DC_PIECE_ABORT,(s=>{t.warn(`peer ${e.remotePeerId} download aborted, reason ${s.reason}`),this._handlePieceAborted(e.remotePeerId),this.config.live&&this.checkPeers&&this.checkPeers()})).on(k.DC_DISCONNECT,(()=>{this.peersNum>=this.minConns&&(this.logger.warn(`close disconnected peer ${e.remotePeerId}`),e.close(!1))}))}_broadcastToPeers(e,t){for(let s of this.getPeers())t&&s===t||s.sendJson(e)}_peersStats(e){this.engine.emitEvent("peers",e);const t=this.engine.config.getPeersInfo;I(t)&&t(e)}startCheckPeersTimer(){this.logger.info("startCheckPeersTimer");const e=()=>{this.checkPeers();const t=1e3*(0===(s=this.loadedPeerNum)?3:.5*s+1.67);var s;this.loadedPeerNum=0,this.checkTimer=setTimeout(e,t)};this.checkTimer=setTimeout(e,15e3)}removeStreamListener(e,t){const s=this.requestingMap.get(e);if(s)return void s.removeStreamListener(t);const i=this.segmentBuilderMap.get(e);i&&i.removeStreamListener(t)}setTargetPeersFromGroup(e,t,s,i){if(e.hasReversePeer){if((s=t.concat(s)).length>0)return this.targetPeers.forwardPeer=s[0],!0}else if(e.hasForwardPeer&&(i=t.concat(i)).length>0)return this.targetPeers.reversePeer=i[0],!0;return t.length>0?(e.hasForwardBuffer?this.targetPeers.reversePeer=t[0]:this.targetPeers.forwardPeer=t[0],!0):(this.targetPeers=T(t,s,i),this.targetPeers.some((e=>!!e)))}}const nt=it;class rt{constructor(){this.internalMap=new Map}has(e){return this.internalMap.has(e)}set(e,t){if(this.internalMap.has(e)){const s=this.internalMap.get(e);if(s&&!s.includes(t))return void s.push(t)}this.internalMap.set(e,[t])}setPeerUnknown(e){this.internalMap.set(e,null)}checkIfPeerUnknown(e){return this.internalMap.has(e)&&!this.internalMap.get(e)}getAllPeerIds(e){const t=this.internalMap.get(e);return t||[]}get(e){return this.getOnePeerId(e)}getOnePeerId(e){if(this.internalMap.has(e)){if(this.internalMap.get(e))return this.internalMap.get(e)[0]}return null}delete(e){this.internalMap.delete(e)}clear(){this.internalMap.clear()}}const ot=class extends nt{constructor(e,t){super(e,t),this.requestingMap=new rt,this.bitset=new Set,this.bitCounts=new Map}handshakePeer(e){this._setupDC(e);const{asn:t,country:s}=this.engine.fetcher.announceInfo;e.sendMetaData(Array.from(this.bitset),this.sequential,this.peersNum,{asn:t,country:s},this.isMobileNet)}handleMetaData(e,t){t.field&&(e.bitset=new Set(t.field),t.field.forEach((e=>{this.bitset.has(e)||this._increBitCounts(e)})),this.addPeer(e),this.downloadOnly&&this.chokePeerRequest(e))}peersHas(e){return this.bitCounts.has(e)}_decreBitCounts(e){if(this.bitCounts.has(e)){let t=this.bitCounts.get(e);1===t?this.bitCounts.delete(e):this.bitCounts.set(e,t-1)}}_increBitCounts(e){if(this.bitCounts.has(e)){let t=this.bitCounts.get(e);this.bitCounts.set(e,t+1)}else this.bitCounts.set(e,1)}reportDCTraffic(e,t,s){if(!this.engine.fetcher)return;const{fetcher:i}=this.engine;let n=t;this.bitset.has(e)||i.reportDCTraffic(n,s)}cleanRequestingMap(e){const t=this.peerManager.getPeer(e);for(let[s,i]of this.requestingMap.internalMap)i&&i.includes(e)&&(this.logger.info(`delete ${s} in requestingMap`),this.requestingMap.delete(s),this._decreBitCounts(s),t&&t.bitset.delete(s))}getPeerLoadedMore(e){if(!this.requestingMap.has(e))return null;const t=this.requestingMap.getAllPeerIds(e);if(0===t.length)return null;let s=this.peerManager.getPeer(t[0]);if(!s)return null;if(t.length>1)for(let e=1;e<t.length;e++){const i=this.peerManager.getPeer(t[e]);i&&i.bufArr.length>s.bufArr.length&&(s=i)}return s}};function at(e,t=!1){if(e){if("string"==typeof e)return document.querySelector(e);if(!t&&"[object HTMLVideoElement]"===Object.prototype.toString.call(e)||t&&"[object HTMLAudioElement]"===Object.prototype.toString.call(e))return e}return t?document.getElementsByTagName("audio")[0]:document.getElementsByTagName("video")[0]}function ht(e,t,s){return fetch(new Request(e,{headers:new Headers({Range:`bytes=${t}-${s}`})})).then((e=>e.arrayBuffer()))}const ct=e=>`${e}`;class lt extends ot{constructor(e,t){super(e,t),this.sequential=!0,this.fileSize=e.filesize,this.fragSize=t.pieceLength,this.currentSrc=e.currentSrc,this.minBufferLength=t.minBufferLength,this.endSN=Math.floor(this.fileSize/this.fragSize),this.server=t.fetcher,this.resolveMap=new Map,this.currLostSN=-1,this.nextLostSN=-1,this.logger=e.logger,this.startCheckPeersTimer(),this.sessionId=void 0,this.minBufferCount=t.minBufferCount}notifySWMessage(e,t,s,i){switch(e){case et.SW_MEDIA:this.server.increMediaRequests(),this.handleActionMedia(t);break;case et.SW_GET_FRAG:try{this.handleActionGetFrag(t,s,i)}catch(e){return this.logger.error(e),this.getFragAck(s,void 0)}break;default:this.logger.warn(`unknown action ${e}`)}}async handleActionGetFrag(e,t,s){const{logger:i}=this,{offset:n,length:r,sessionId:o}=e;if(n>=this.fileSize||o!==this.sessionId||0===r)return s(),this.getFragAck(t,void 0);const{valid:a,sn:h,byteEnd:c,endClosed:l,normalByteStart:d}=function(e,t,s,i){let n=!0,r=!0,o=e+s-1;const a=0|Math.floor(e/s),h=a*s,c=a*s+s-1;return a===Math.floor(i/s)?(o=e+t-1,o<i-1&&(r=!1),n=e%s==0&&r,o>=i&&(o=i-1)):e+t<c?(n=!1,r=!1,o=e+t-1):e%s!=0&&(n=!1,o=h+s-1),{valid:n,sn:a,byteEnd:o,endClosed:r,normalByteStart:h}}(n,r,this.fragSize,this.fileSize),u=a?0:n-d;this.loadingSN=h;const g=ct(h);if(i.info(`loadingSN ${this.loadingSN}`),!l){let e;try{e=await ht(this.currentSrc,n,c),this.checkBuffer()}catch(e){i.warn(e)}return this.getFragAck(t,e,u)}if(await this.bufMgr.hasSegOfSN(h)){i.info(`bufMgr found seg sn ${h} segId ${g}`);const e=await this.bufMgr.getSegBySN(h);let s=e.data;return this.engine.emit(et.FRAG_LOADED,h,g,e.from),this.checkBuffer(),this.getFragAck(t,s,u)}let f,p=this.bufferedDuration;if(p>this.minBufferLength&&(this.requestingMap.has(h)||this.peersHas(h))){let e=p-this.minBufferLength;e>8?e=8:e<2&&(e=2);let s=!1;if(this.requestingMap.has(h))s=!0,i.info(`wait for criticalSeg sn ${h} timeout ${e}`);else for(let t of this.peerManager.getPeersOrderByWeight())if(t.bitset.has(h)){i.info(`found sn ${h} from peer ${t.remotePeerId}`),t.requestDataById(g,h,!0),this.requestingMap.set(h,t.remotePeerId),i.info(`request criticalSeg sn ${h} from ${t.remotePeerId} timeout ${e}`),s=!0;break}if(s){const s=new Promise((t=>{const s={resolve:t,sn:h,criticaltimeouter:setTimeout(this._criticaltimeout.bind(this,h,!1),1e3*e)};this.resolveMap.set(h,s)})),n=await s;if(n&&n.data){const{data:e}=n;return i.info(`loaded from promise sn ${h} size ${e.byteLength}`),this.engine.emit(et.FRAG_LOADED,h,g,"http"===n.fromPeerId?"HTTP":"P2P"),this.checkBuffer(),this.getFragAck(t,e,u)}}}try{f=await this.requestPieceByHttp(h,g),this.engine.emit(et.FRAG_LOADED,h,g,"HTTP")}catch(e){i.warn(e)}return this.getFragAck(t,f,u)}handleActionMedia(e){const{rangeStart:t,sessionId:s}=e;this.sessionId=s}updateLoadedSeg(e,t){if(!this.bitset.has(e)&&(this.bitset.add(e),this.bitCounts.has(e)&&this.bitCounts.delete(e),!this.downloadOnly))for(let s of this.getPeers())s.notifySet.has(e)||s.bitset.has(e)||(s.sendMsgHave(e,t),s.notifySet.add(e))}checkBuffer(){const{logger:e}=this.engine;if(0===this.minBufferCount)return;let t=this.loadingSN+1;const s=t+this.minBufferCount;for(;t<s&&!(t>this.endSN);){if(!this.bitset.has(t)&&!this.requestingMap.has(t)){this.requestingMap.set(t,"http"),e.info(`request prefetch ${t} from http`),this.requestPieceByHttp(t,ct(t));break}t++}}checkPeers(){const{logger:e}=this.engine;if(0===this.bitCounts.size)return;if(this.nextLostSN>=0&&this.nextLostSN>=this.loadingSN-30)return;if(!this.hasPeers)return;const t=this.peerManager.getAvailablePeers();if(0===t.length)return;const s=[],{prefetchNum:i}=this.config;let n=0,r=this.loadingSN+1;for(;s.length<=i&&s.length<t.length&&n<200;){if(r>this.endSN)return;if(this.bitset.has(r))r++;else{if(this.bitCounts.has(r)&&!this.requestingMap.has(r))for(let i of t)if(!s.includes(i)&&i.bitset.has(r)){i.requestDataById(ct(r),r,!1),e.info(`request prefetch ${r} from peer ${i.remotePeerId} downloadNum ${i.downloadNum}`),s.push(i),this.requestingMap.set(r,i.remotePeerId);break}n++,r++}}this.loadedPeerNum=s.length}deletePeer(e){this.peerManager.hasPeer(e.remotePeerId)&&e.bitset.forEach((e=>{this._decreBitCounts(e)})),super.deletePeer(e)}addPeer(e){super.addPeer(e)}get bufferedDuration(){let e=this.engine.media;if(!e){if(this.logger.info("try get media element"),e=at(this.config.mediaElem,this.engine.isAudio),!e)return 5;this.engine.media=e}let t=function(e){let t=0,s=e.currentTime,i=e.buffered;for(let e=i.length-1;e>=0;e--)if(s>=i.start(e)&&s<=i.end(e)){t=i.end(e)-s;break}return e.playbackRate&&(t/=e.playbackRate),t>0?t:0}(e);return this.logger.info(`bufferedDuration ${t}`),t}onBufferManagerLost(e,t,s){this.currLostSN=e,s&&(this.nextLostSN=s),this.bitset.delete(e),this.bitCounts.delete(e)}destroy(){this.logger.warn("destroy MediaScheduler");for(let e of this.resolveMap.values())e.criticaltimeouter&&clearTimeout(e.criticaltimeouter);super.destroy()}_setupDC(e){super._setupDC(e);const{logger:t}=this.engine;e.on(et.DC_HAVE,(t=>{if(!t.sn||!e.bitset)return;const s=t.sn;e.bitset.has(s)||(e.bitset.add(s),this.bitset.has(s)||this._increBitCounts(s))})).on(et.DC_LOST,(t=>{if(!t.sn||!e.bitset)return;const s=t.sn;e.bitset.has(s)&&(e.bitset.delete(s),this._decreBitCounts(s))})).on(et.DC_PIECE_NOT_FOUND,(s=>{const i=s.sn;if(this.resolveMap.has(i)){const e=this.resolveMap.get(i);this.resolveMap.delete(i),clearTimeout(e.criticaltimeouter),t.info(`DC_PIECE_NOT_FOUND ${i}`),e.resolve()}e.bitset.delete(i),this.requestingMap.delete(i),this._decreBitCounts(i),e.checkIfNeedChoke(!0)})).on(et.DC_RESPONSE,(async(s,i)=>{const{segId:n,sn:r,data:o}=s,a=this.resolveMap.has(r);if(super.reportDCTraffic(r,s.size,i),a){t.info(`receive criticalSeg sn ${r}`);const s=this.resolveMap.get(r);this.resolveMap.delete(r),clearTimeout(s.criticaltimeouter),e.miss=0,s.resolve({data:o,fromPeerId:e.remotePeerId})}if(this.bitset.has(r))return;const h=new F(r,n,o,e.remotePeerId);await this.bufMgr.putSeg(h),this.updateLoadedSeg(r,n),this.requestingMap.delete(r)})).on(et.DC_REQUEST,(async t=>{const s=await this.bufMgr.getSegBySN(t.sn);s?e.sendBuffer(s.sn,s.segId,s.data):e.sendJson({event:et.DC_PIECE_NOT_FOUND,seg_id:ct(t.sn),sn:t.sn})}))}_setupEngine(){this.engine.on(et.FRAG_LOADED,((e,t)=>{}))}_criticaltimeout(e,t=!1){const{logger:s,config:i}=this,n=this.resolveMap.get(e);if(!n)return void s.warn("_criticaltimeout no promise");let r;s.info(`critical request ${e} timeout`),this.requestingMap.has(e)&&(r=this.getPeerLoadedMore(e));let o=!1;if(r&&(o=!r.loadtimeout()),o)return void s.info("p2p download completed");const{sn:a}=n;if(t&&r&&r.shouldWaitForRemain(-498))return s.info(`wait for peer load remain of ${e}`),void(this.criticaltimeouter=setTimeout(this._criticaltimeout.bind(this,e),-298));if(r&&r.bufSN===a&&r.bufArr.length>0){const{start:e,end:t}=this.getRangeOfPiece(a);let i=f.h.concat(r.bufArr);s.info(`continue download range: ${e+i.byteLength}-${t}`),ht(this.currentSrc,e+i.byteLength,t).then((e=>{let t=f.h.from(e);this.server.reportFlow(t.byteLength);let s=f.h.concat([i,t]);n.resolve({data:s,fromPeerId:r.remotePeerId})})).catch((e=>{s.warn(e),n.resolve()}))}else n.resolve();this.resolveMap.delete(e)}notifyPeersLoaded(e){}_handlePieceAborted(e){for(let[t,s]of this.requestingMap.internalMap)if(s&&s.includes(e)){if(this.resolveMap.has(t)){const e=this.resolveMap.get(t);window.clearTimeout(e.criticaltimeouter),this._criticaltimeout(t),this.resolveMap.delete(t)}this.logger.info(`delete ${t} in requestingMap`),this.requestingMap.delete(t)}}async requestPieceByHttp(e,t){const{logger:s,engine:i}=this;let{start:n,end:r}=this.getRangeOfPiece(e);s.info(`requestPieceByHttp sn ${e}`);const o=await ht(this.currentSrc,n,r);if(this.server.reportFlow(o.byteLength),!await this.bufMgr.hasSegOfSN(e)){const i=new F(e,t,o,"");await this.bufMgr.putSeg(i),s.info(`bufMgr putSeg ${t}`),this.updateLoadedSeg(e,t)}if(this.resolveMap.has(e)){const t=this.resolveMap.get(e);this.resolveMap.delete(e),clearTimeout(t.criticaltimeouter),s.info(`http loaded ${e}`),t.resolve({data:o,fromPeerId:"http"})}else this.checkBuffer();return o}getRangeOfPiece(e){const t=e*this.fragSize;let s=t+this.fragSize-1;return s>=this.fileSize&&(s=this.fileSize-1),{start:t,end:s}}getFragAck(e,t,s){let i=t;s>0&&(this.logger.info(`slice buffer from ${s}`),i=i.slice(s)),e.postMessage({action:et.SW_GET_FRAG,data:{buffer:i}})}}const dt=1e3;function ut(e){const t=new Promise(((t,s)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>s(e.error)})),s=C(dt,"indexedDB timeout");return Promise.race([t,s])}const gt={};async function ft(e,t,s=!0){const i=gt[e]||{};i.promise||(i.promise=new Promise((e=>i.resolve=e)),gt[e]=i,mt(e,t,i.resolve,s));const n=await i.promise;return delete i.promise,n}const pt={};async function mt(e,t,s,i){if(!pt[e]){const i=indexedDB.open(e);return i.onupgradeneeded=()=>{const e=i.result;t.forEach((t=>{e.createObjectStore(t)}))},void s(pt[e]=await ut(i))}if(i)try{t.forEach((t=>{pt[e].transaction(t)})),s(pt[e])}catch(n){console.error(`Could not open a transaction on "${e}" due to ${n.name} (${n.message}). Trying to reopen the connection...`),delete pt[e],mt(e,t,s,i)}else s(pt[e])}let _t;function St(){return _t||(_t=createStore("keyval-store","keyval")),_t}function yt(e,t=St()){return t("readonly",(t=>ut(t.get(e))))}function vt(e,t,s=St()){return s("readwrite",(s=>(s.put(t,e),ut(s.transaction))))}function Ct(e,t=St()){return t("readwrite",(t=>(t.delete(e),ut(t.transaction))))}function wt(e=St()){return e("readwrite",(e=>(e.clear(),ut(e.transaction))))}function Pt(e,t){return e.openCursor().onsuccess=function(){this.result&&(t(this.result),this.result.continue())},ut(e.transaction)}const bt="size";class Et extends(a()){constructor(e,t){super(),this.name="SegmentStore",this.logger=t.logger,this.logger.info(`use ${this.name}`),this.engine=e,this.channel=e.channel;const s=e.browserInfo.device;this.isPC=s===U().device.PC_WEB||s===U().device.PC_NATIVE,this.maxBufSize=this.isPC?t.diskCacheLimit.pc:t.diskCacheLimit.mobile,this.overflowed=!1,this.countErrors=0,this.isCleared=!0,this.destroyed=!1}async setupStore(){if(navigator.storage&&navigator.storage.estimate){const e=await navigator.storage.estimate(),t=Math.floor(e.quota-e.usage);t<this.maxBufSize&&(this.maxBufSize=t-104857600)}return new Promise((async(e,t)=>{if(this.isPC&&this.maxBufSize<419430400||!this.isPC&&this.maxBufSize<104857600)return void t("disk storage not enough");const s=this.stores;let i;try{i=function(e,t){let s=ft(e,t);return t.map((i=>(n,r)=>s.then((o=>{try{const e=o.transaction(i,n).objectStore(i);return r(e)}catch(o){s=ft(e,t),s.then((e=>r(e.transaction(i,n).objectStore(i))))}}))))}(this.channel,s)}catch(e){return void t(e)}this._createStores(i),this._initMetaStore().then(e).catch(t)}))}_initMetaStore(){return vt(bt,0,this.metaStore)}currBufSize(){return new Promise((async(e,t)=>{try{const s=await yt(bt,this.metaStore);if(isNaN(s))return void t("size is NaN");e(s)}catch(e){t(e)}}))}async putSeg(e){if(this.destroyed)return;this.isCleared=!1;const{logger:t}=this;if(b(e.data))return new Promise((s=>{this._addSeg(e).then((e=>{this._onSegPut(e),this.emit(k.BM_SEG_ADDED,e),this.countErrors=0,s()})).catch((e=>{this._handleFataError(),e&&(t.warn(`putSeg ${e}`),("QuotaExceededError"===e.name||e.inner&&"QuotaExceededError"===e.inner.name)&&this.currBufSize().then((e=>{this._trimDisk(e,!0)})).catch((e=>{this.logger.error(`trimDisk ${e}`)}))),s()}))}));t.error(`putSeg ${e.segId} is not buffer`)}_handleFataError(){this.countErrors++,this.countErrors>=3&&(this.engine.emit(k.BM_FATAL_ERROR),this.countErrors=0)}_decreaseBufSize(e){this.currBufSize().then((t=>{t&&vt(bt,t-e,this.metaStore)})).catch((e=>{this.logger.warn(`decreaseBufSize ${e}`)}))}_increaseBufSize(e){this.destroyed||this.currBufSize().then((t=>{vt(bt,t+e,this.metaStore),this._trimDisk(t+e)}))}clear(e=!1){if(!this.isCleared){this.logger.warn("clear segment store");try{this._clearDisk(e)}catch(e){}this.isCleared=!0}}_clearDisk(e){wt(this.segmentsStore),e?this._initMetaStore():wt(this.metaStore),this.overflowed=!1}destroy(){this.clear(),this.removeAllListeners(),this.destroyed=!0}}const It=Et;const Tt=class extends It{constructor(e,t){super(e,t),this.stores=["segments","metadata"]}_createStores(e){this.segmentsStore=e[0],this.metaStore=e[1]}async hasSegOfSN(e){return new Promise(((t,s)=>{yt(e,this.segmentsStore).then((e=>{t(!!e)})).catch((e=>{this.logger.warn(e),t(!1)}))}))}async getSegBySN(e){return new Promise((t=>{const{logger:s}=this;yt(e,this.segmentsStore).then((i=>{if(i)return b(i.data)?void t(F.fromSegment(i)):(s.error(`getSegBySN ${e} is not buffer`),void t(null));t(null)})).catch((e=>{s.warn(e),this._handleFataError(),t(null)}))}))}_addSeg(e){const{sn:t,size:s}=e;return new Promise(((i,n)=>{vt(t,this._segmentToCache(e),this.segmentsStore).then((()=>{this._increaseBufSize(s),i(e)})).catch((e=>{n(e)}))}))}async _trimDisk(e,t=!1){if(this.isCleared||this.destroyed)return;let s=this.maxBufSize;const{logger:i}=this;t&&(s=e-104857600,s<0&&(s=0)),e<s||(i.warn(`_trimDisk currentSize ${e} upBound ${s}`),function(e=St()){return e("readonly",(e=>{if(e.getAllKeys)return ut(e.getAllKeys());const t=[];return Pt(e,(e=>t.push(e.key))).then((()=>t))}))}(this.segmentsStore).then((async t=>{t.sort(((e,t)=>e-t));let n=0;do{if(n++>10){i.warn("too much loops in SegmentStore");break}const s=t.shift();if(void 0===s){i.warn("oldestSegId not found");continue}const r=await yt(s,this.segmentsStore);if(!r){i.warn("lastSeg not found");continue}const o=r.data.byteLength;Ct(s,this.segmentsStore).then((()=>{this._decreaseBufSize(o)})),e-=o,i.info(`pop sn ${s} size ${o} currBufSize ${e}`),this.emit(k.BM_LOST,{sn:s}),this.overflowed||(this.overflowed=!0)}while(e>=s)})))}_segmentToCache(e){return{data:e.data,segId:e.segId,sn:e.sn}}_onSegPut(e){this.emit(`${k.BM_ADDED_SN_}${e.sn}`,e)}};class At extends(a()){constructor(e,t){super(),this.name="SegmentCache",this.logger=t.logger,this.logger.info(`use ${this.name}`);const s=e.browserInfo.device;if(this.maxBufSize=s===U().device.PC_WEB||s===U().device.PC_NATIVE?t.memoryCacheLimit.pc:t.memoryCacheLimit.mobile,this.isLive=t.live,this.isLive)this.maxBufSize=47185920;else{if(0===this.maxBufSize)throw new Error("cannot use SegmentCache");const e=function(){const{memory:e}=performance;return e?e.jsHeapSizeLimit-e.usedJSHeapSize:-1}();e>=0&&e<this.maxBufSize&&(this.maxBufSize=e-31457280)}this._segPool=new Map,this._currBufSize=0,this.overflowed=!1,this.isCleared=!0,this.destroyed=!1}get currBufSize(){return this._currBufSize}_calSegPoolSize(){let e=0;return this._segPool.forEach((t=>{t.forEach((t=>{e+=t.size}))})),e}async putSeg(e){this.destroyed||(this.isCleared=!1,this._currBufSize>=1.5*this.maxBufSize&&(this._currBufSize=this._calSegPoolSize(),this._currBufSize>=1.5*this.maxBufSize&&(this.clear(),this.overflowed=!1)),b(e.data)?this._addSeg(e):this.logger.error(`putSeg ${e.segId} is not buffer`))}clear(){this.isCleared||(this.logger.warn("clear segment cache"),this._segPool.clear(),this._currBufSize=0,this.isCleared=!0,this.overflowed=!1)}destroy(){this.clear(),this.removeAllListeners(),this.destroyed=!0}}const Rt=At;const Dt=class extends Rt{constructor(e,t){super(e,t)}async hasSegOfSN(e){return new Promise(((t,s)=>{t(this._segPool.has(e))}))}getSegBySN(e){return new Promise(((t,s)=>{t(this._segPool.get(e))}))}_addSeg(e){const{logger:t}=this,{size:s,sn:i}=e;e.from=e.fromPeerId?"P2P":"HTTP",this._segPool.set(i,e),this._currBufSize+=parseInt(s);const n=this._segPool.size;if(this.emit(`${k.BM_ADDED_SN_}${e.sn}`,e),this.emit(k.BM_SEG_ADDED,e),this._currBufSize<this.maxBufSize||n<=5)return;let r=Array.from(this._segPool.keys()).sort(((e,t)=>e-t)),o=0;do{if(o++>10){console.error("too much loops in SegmentCache");break}const e=r.shift();if(void 0===e){t.error("lastSN not found");continue}const s=r[0],i=this._segPool.get(e);if(!i){t.error("lastSeg not found");continue}const n=i.size;this._currBufSize-=parseInt(n),this._segPool.delete(e),t.info(`pop seg ${e} size ${n} currBufSize ${this._currBufSize}`),this.overflowed||(this.overflowed=!0),this.emit(k.BM_LOST,{sn:e,segId:i.segId,next:s,level:i.level})}while(this._currBufSize>=this.maxBufSize&&this._segPool.size>5)}};class Mt extends Ze{static get Events(){return et}static isWebRTCSupported(){return Ze.isSupported()}static isServiceWorkerSupported(){return"serviceWorker"in navigator}static isSupported(){return Ze.isSupported()&&Mt.isServiceWorkerSupported()}constructor(e={}){if(super(e),this.config=Object.assign({},r,e),this.swSupported=(0,z.isLocalHost)()||P,this.config.pieceLength<=10240)throw new Error("pieceLength is too short");this.currentSrc=void 0,this.filesize=-1,this.contentType="",this.isAudio=!1,this.media=at(this.config.mediaElem),this.workerKeepAliveInterval=null,this.workerPortCount=0,Mt.isServiceWorkerSupported()?Mt.isWebRTCSupported()||(console.warn("WebRTC is not supported"),this.p2pEnabled=!1):(this.swSupported=!1,console.warn("service worker is not supported"),this.p2pEnabled=!1),this.logger=this.initLogger(),this.swSupported&&(navigator.serviceWorker.onmessage=async e=>{this.workerPortCount++,this._wrapRequest(e)})}getProxiedUrl(t){if(!this.p2pEnabled||function(){const e=navigator.userAgent.toLowerCase();if(e.indexOf("android")>-1&&parseFloat(e.slice(e.indexOf("android")+8))<5)return!0;return!1}())return Promise.resolve(t);this.currentSrc&&this.currentSrc!==t&&this.restartP2p(),this.currentSrc=t;const s=new Promise(((e,s)=>{this.registerServiceWorker().then((i=>{const n=new URL(i.scope);this.pathname=n.pathname+p;const r=t.split("?")[0].split("/");this.filename=r[r.length-1],fetch(`${this.pathname}/cancel/`).then((i=>{i.ok&&200===i.status?(i.body.cancel(),e(`${this.pathname}/${this.filename}?src=${window.encodeURIComponent(t)}`)):s(i.status)})).catch((e=>{s(e)}))})).catch((e=>{s(e)}))})),i=async function(e){return new Promise(((t,s)=>{const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onerror=e=>{s(e)},i.onprogress=e=>{let n=e.total;i.onprogress=null,i.onerror=null,i.abort(),null!=n&&0!==n?t({total:n,contentType:i.getResponseHeader("Content-Type")}):s("cannot get file length")},i.send()}))}(t);return new Promise((n=>{Promise.all([s,i]).then((s=>{this.filesize=s[1].total,this.contentType=s[1].contentType;const i=function(t){const s=e.parseURL(t);let i=s.path.substring(s.path.lastIndexOf(".")+1);return i.endsWith("/")&&(i=i.substring(0,i.length-1)),i}(t);var r;this.config.audioTypes.includes(i)&&(this.isAudio=!0),this.contentType||(this.contentType="mp3"===(r=i)?"audio/mpeg":"wav"===r?"audio/wav":"webm"===r?"video/webm":"video/mp4"),this.filesize>0?n(s[0]):n(t)})).catch((e=>{console.error(e),n(t)}))}))}watchRebuffering(e){this.offEventRebuffer=function(e,t){let s=null;const i=()=>{s||(s=setTimeout((()=>{t()}),2500))},n=()=>{null!=s&&(clearTimeout(s),s=null)};return e.addEventListener("waiting",i),e.addEventListener("playing",n),()=>{e.removeEventListener("waiting",i),e.removeEventListener("playing",n)}}(e,(()=>{this.fetcher&&this.fetcher.increRebuffers()}))}async _wrapRequest(e){const[t]=e.ports,s=()=>{t.onmessage=null,this.workerPortCount--,this.workerPortCount||(clearInterval(this.workerKeepAliveInterval),this.workerKeepAliveInterval=null)},i=async e=>{const{action:i,data:n}=e;switch(this.logger&&this.logger.info(`engine onmessage action ${i}`),i===et.SW_GET_FRAG&&(this.segmentLoadCount++,this.segmentLoadCount>=this.config.startFromSegmentOffset&&this.resumeTracker()),i){case et.SW_CANCEL:s();break;case et.SW_MEDIA:await this.handleActionMedia(n,t);default:this.config.scheduler?this.config.scheduler.notifySWMessage(i,n,t,s):t.postMessage({action:i,data:{disabled:!0}})}};t.onmessage=async({data:e})=>{i(e),this.workerKeepAliveInterval||navigator.serviceWorker.getRegistration().then((e=>{const t=()=>e&&e.active&&"activated"===e.active.state;if(t()){const e=()=>{clearInterval(this.workerKeepAliveInterval),this.workerKeepAliveInterval=null};this.workerKeepAliveInterval=setInterval((()=>{var s;t()?(s=this.pathname,new Promise(((e,t)=>{fetch(`${s}/keepalive/`).then((e=>{if(e.ok)return e.text();throw new Error("keepalive failed")})).then((t=>{if(""!==t.trim())throw new Error("not valid keepalive response");e()})).catch((e=>{t(e)}))}))).catch((t=>{console.error(t),e()})):e()}),15e3)}}))},i(e.data)}async handleActionMedia(e,t){const{config:s,logger:i}=this;i.info(`currentSrc ${this.currentSrc} filesize ${this.filesize} isAudio ${this.isAudio}`),this.tracker||await this._connectServer(),t.postMessage({action:et.SW_MEDIA,data:{debug:this.logger&&this.logger.isDebugLevel,disabled:!this.bufMgr,total:this.filesize,contentType:this.contentType,filename:this.filename}})}async _connectServer(){const{config:e,logger:s}=this;let{token:i,channelId:n}=this.config,r=(e,s)=>{const i=t().parseURL(e);return`${i.netLoc.substring(2)+i.path}`};n&&(r=this.makeChannelId(i,n));const o=this.makeSignalId(),a=this.commonBrowserInfo;this.browserInfo={...a,tag:this.config.tag||void 0,type:"media"},a.device===z.device.PC_NATIVE&&(this.browserInfo={...this.browserInfo,app:this.config.appName,bundle:this.config.appId}),this.channel=`${r(this.currentSrc,this.browserInfo)}|${o}[${G.VERSION}]m_${this.config.pieceLength}`,s.info(`SDK version: ${Mt.version} channel ${this.channel}`);try{await this._init(this.channel,this.browserInfo)}catch(e){s.warn(e.message),this.p2pEnabled=!1}}getExtraForStats(){const e=super.getExtraForStats();return this.media&&(e.pos=Math.round(this.media.currentTime)),e}async registerServiceWorker(){if(!Mt.isServiceWorkerSupported()){let e="sw is not supported";return P||(e="not https url"),Promise.reject(new Error(e))}const{logger:e,config:t}=this;this.media=at(this.config.mediaElem,this.isAudio),this.media||e&&e.warn("no media element found");const{serviceWorker:s}=navigator;return s.getRegistration().then((e=>e||Promise.race([s.register(t.swFile,{scope:t.swScope}).then((e=>function(e){return new Promise(((t,s)=>{const i=e.installing||e.waiting||e.active,n=()=>"activated"===i.state&&(i.removeEventListener("statechange",n),t(e),!0);n()||i.addEventListener("statechange",n)}))}(e))),C(800,"register sw timeout")])))}unregisterServiceWorker(){const{config:e}=this,t="serviceWorker is not registered";return new Promise(((e,s)=>{const{serviceWorker:i}=navigator;i||s(t),i.getRegistration().then((i=>{i?i.unregister().then(e).catch((()=>{s(t)})):s(t)}))}))}async _init(e,t){if(!this.p2pEnabled||"object"!=typeof self)return;await this.initSegmentManager((e=>{if(this.tracker){const{scheduler:t}=this.tracker;t.bufferManager=e,t.bitset.clear()}})),this.media&&(t.pos=Math.round(this.media.currentTime)),t.tag=`${(0,z.getBrowser)()}_${"SegmentStore"===this.bufMgr.name?"d":"m"}`;let s=new Be(this,this.config.token,window.encodeURIComponent(e),this.config.announce||"",t);this.fetcher=s,this.config.fetcher=s;const i=setInterval((()=>{this.media?(clearInterval(i),this.watchRebuffering(this.media)):this.media=at(this.config.mediaElem)}),3e3),n=new lt(this,this.config);n.bufferManager=this.bufMgr,this.tracker=new fe(this,s,n,this.config),this.config.scheduler=this.tracker.scheduler,this.setupWindowListeners()}restartP2p(){this.logger&&this.logger.warn("restart P2P"),this.disableP2P(),this.enableP2P()}enableP2P(){return this.p2pEnabled?null:(this.logger&&this.logger.info("enable P2P"),this.config.p2pEnabled=this.p2pEnabled=!0,this)}disableP2P(){this.logger&&this.logger.warn("disable P2P"),this.p2pEnabled&&(this.config.p2pEnabled=this.p2pEnabled=!1,this.tracker&&this.tracker instanceof fe&&(this.tracker.stopP2P(),this.tracker=null,this.fetcher=null,this.bufMgr.destroy(),this.bufMgr=null)),this.currentSrc="",this.filesize=-1,this.media=void 0}destroy(){this.offEventRebuffer&&this.offEventRebuffer(),super.destroy()}async initSegmentManager(e){const{logger:t,config:s}=this;if(window.indexedDB&&s.useDiskCache){const e=new Tt(this,s);try{await e.setupStore(),this.bufMgr=e}catch(e){t.warn(e),this.bufMgr=new Dt(this,s)}}else this.bufMgr=new Dt(this,this.config);"SegmentStore"===this.bufMgr.name&&(this.removeAllListeners(et.BM_FATAL_ERROR),this.once(et.BM_FATAL_ERROR,(()=>{const i="SegmentStoreFatalError";t.warn(`${i}, switch to SegmentCache`),this.bufMgr.destroy(),this.bufMgr=new Dt(this,s),e&&e(this.bufMgr),t&&t.reportUrl&&t.report(JSON.stringify(this.browserInfo),i,this.peerId,"1.2.0",5e4)})))}}"object"==typeof self&&(self.P2PEngineMedia=self.P2pEngineMp4=self.P2PEngineMp4=Mt);const Lt=Mt})();var n=i.A;export{n as default};